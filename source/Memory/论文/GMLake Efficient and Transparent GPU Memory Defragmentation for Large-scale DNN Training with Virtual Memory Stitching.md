# GMLake: Efficient and Transparent GPU Memory Defragmentation for Large-scale DNN Training with Virtual Memory Stitching

GMLakeï¼šé€šè¿‡è™šæ‹Ÿå†…å­˜æ‹¼æŽ¥è¿›è¡Œå¤§è§„æ¨¡ DNN è®­ç»ƒçš„é«˜æ•ˆã€é€æ˜Žçš„ GPU å†…å­˜ç¢Žç‰‡æ•´ç†

------

Abstractï¼šå¤§è§„æ¨¡æ·±åº¦ç¥žç»ç½‘ç»œï¼ˆDNNï¼‰ï¼Œå¦‚å¤§åž‹è¯­è¨€æ¨¡åž‹ï¼ˆLLMï¼‰ï¼Œå·²ç»å½»åº•æ”¹å˜äº†äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰é¢†åŸŸï¼Œå¹¶å˜å¾—è¶Šæ¥è¶Šå—æ¬¢è¿Žã€‚ç„¶è€Œï¼Œè®­ç»ƒæˆ–å¾®è°ƒæ­¤ç±»æ¨¡åž‹éœ€è¦å¤§é‡çš„è®¡ç®—èƒ½åŠ›å’Œèµ„æºï¼Œå…¶ä¸­å•ä¸ªåŠ é€Ÿè®¾å¤‡ï¼ˆå¦‚GPUï¼‰çš„å†…å­˜å®¹é‡æ˜¯æœ€é‡è¦çš„ç“¶é¢ˆä¹‹ä¸€ã€‚

**ç”±äºŽGPUåŽŸç”Ÿå†…å­˜åˆ†é…å™¨çš„å¼€é”€æžå¤§ï¼ˆä¾‹å¦‚ï¼Œ10å€ï¼‰ï¼ŒPyTorchå’ŒTensorFlowç­‰DNNæ¡†æž¶é‡‡ç”¨äº†ä¸€ç§ç¼“å­˜åˆ†é…å™¨ï¼Œå®ƒç»´æŠ¤ä¸€ä¸ªå†…å­˜æ± å¹¶ä½¿ç”¨åˆ†å‰²æœºåˆ¶æ¥å¿«é€Ÿè¿›è¡Œå†…å­˜åˆ†é…å’Œé‡Šæ”¾ã€‚**

**ç„¶è€Œï¼Œé’ˆå¯¹æµè¡Œçš„å†…å­˜å‡ç¼©æŠ€æœ¯ï¼ˆå¦‚é‡æ–°è®¡ç®—ã€å¸è½½ã€åˆ†å¸ƒå¼è®­ç»ƒå’Œä½Žç§©é€‚åº”ï¼‰ï¼Œç¼“å­˜åˆ†é…å™¨çš„æ•ˆçŽ‡ä¼šè¿…é€Ÿé™ä½Žã€‚**

**å…¶ä¸»è¦åŽŸå› æ˜¯ï¼Œè¿™äº›å†…å­˜å‡ç¼©æŠ€æœ¯å¼•å…¥äº†é¢‘ç¹ä¸”ä¸è§„åˆ™çš„å†…å­˜ï¼ˆåˆ†é…å’Œé‡Šæ”¾ï¼‰è¯·æ±‚ï¼Œå¯¼è‡´åŸºäºŽåˆ†å‰²çš„ç¼“å­˜åˆ†é…å™¨äº§ç”Ÿä¸¥é‡çš„ç¢Žç‰‡åŒ–é—®é¢˜ã€‚**

ä¸ºå‡è½»è¿™ç§ç¢Žç‰‡åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åŸºäºŽä½Žçº§GPUè™šæ‹Ÿå†…å­˜ç®¡ç†çš„æ–°åž‹å†…å­˜åˆ†é…æ¡†æž¶ï¼Œç§°ä¸ºGPUå†…å­˜æ¹–ï¼ˆGMLakeï¼‰ã€‚

GMLakeé‡‡ç”¨äº†ä¸€ç§æ–°é¢–çš„è™šæ‹Ÿå†…å­˜æ‹¼æŽ¥ï¼ˆVMSï¼‰æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡è™šæ‹Ÿå†…å­˜åœ°å€æ˜ å°„å°†ä¸è¿žç»­çš„å†…å­˜å—èžåˆæˆ–ç»„åˆåœ¨ä¸€èµ·ã€‚

GMLakeå¯ä»¥å‡å°‘å¹³å‡9.2 GBï¼ˆæœ€é«˜è¾¾25 GBï¼‰çš„GPUå†…å­˜ä½¿ç”¨é‡ï¼Œå¹¶åœ¨A100 80 GBå†…å­˜çš„GPUä¸Šå‡å°‘15%ï¼ˆæœ€é«˜è¾¾33%ï¼‰çš„ç¢Žç‰‡åŒ–é—®é¢˜ï¼Œ**é’ˆå¯¹å…«ä¸ªLLMæ¨¡åž‹ã€‚GMLakeå¯¹DNNæ¨¡åž‹å’Œå†…å­˜å‡ç¼©æŠ€æœ¯å®Œå…¨é€æ˜Žï¼Œç¡®ä¿èµ„æºå¯†é›†åž‹æ·±åº¦å­¦ä¹ ä»»åŠ¡çš„æ— ç¼æ‰§è¡Œã€‚**

> åŽŸç”Ÿåˆ†é…å™¨ï¼Œå†…å­˜æ± æŠ€æœ¯ï¼Œå†…å­˜ç¼©å‡æŠ€æœ¯ã€‚



##  Introduction

å¤§è§„æ¨¡æ·±åº¦ç¥žç»ç½‘ç»œï¼ˆDNNï¼‰æ¨¡åž‹ï¼Œç‰¹åˆ«æ˜¯å¤§åž‹è¯­è¨€æ¨¡åž‹ï¼ˆLLMï¼‰ï¼Œå·²ç»å½»åº•æ”¹å˜äº†è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰å’Œäººå·¥æ™ºèƒ½ï¼ˆAIï¼‰ç ”ç©¶é¢†åŸŸ [88]ã€‚å¦‚GPT-3 [8] æž¶æž„çš„LLMï¼Œæ˜¯å¤æ‚çš„DNNæ¨¡åž‹ï¼Œå…·å¤‡åœ¨ç†è§£ã€ç”Ÿæˆå’Œå¤„ç†äººç±»è¯­è¨€æ–¹é¢çš„å“è¶Šèƒ½åŠ›ã€‚è¿™äº›æ¨¡åž‹åˆ©ç”¨äº†å¤§é‡çš„æ–‡æœ¬æ•°æ®ï¼Œå¹¶é‡‡ç”¨ä»¥æ³¨æ„åŠ›æœºåˆ¶ä¸ºç‰¹ç‚¹çš„åŸºäºŽTransformerçš„æž¶æž„ [78]ï¼Œåœ¨å„ç§NLPä»»åŠ¡ä¸Šå®žçŽ°äº†æœ€å…ˆè¿›çš„æ€§èƒ½ã€‚ç„¶è€Œï¼ŒLLMçš„å¹¿æ³›é‡‡ç”¨ä¼´éšç€é‡å¤§çš„è®¡ç®—æŒ‘æˆ˜ï¼Œå› ä¸ºè®­ç»ƒæˆ–å¾®è°ƒæ­¤ç±»æ¨¡åž‹éœ€è¦å¤§é‡çš„è®¡ç®—èƒ½åŠ›å’Œèµ„æºã€‚ä¾‹å¦‚ï¼Œæ‹¥æœ‰1750äº¿å‚æ•°çš„OPT [87]ï¼Œåœ¨1024ä¸ªA100 GPUä¸Šéœ€è¦34å¤©ï¼Œè€Œæ‹¥æœ‰650äº¿å‚æ•°çš„LLaMA [77] å¤„ç†1.4ä¸‡äº¿ä¸ªtokenï¼Œä½¿ç”¨2048ä¸ªA100 GPUå¤§çº¦éœ€è¦21å¤©ã€‚å› æ­¤ï¼Œæ·±åº¦å­¦ä¹ ï¼ˆDLï¼‰æ¡†æž¶å¦‚PyTorch [63] å’ŒTensorFlow [76] å·²æˆä¸ºDNNæ¨¡åž‹çš„åŸºç¡€è®¾æ–½ï¼Œå› å…¶çµæ´»æ€§å’Œè®¡ç®—æ•ˆçŽ‡è€Œå¤‡å—æŽ¨å´‡ã€‚è¿™äº›DLæ¡†æž¶ä½¿å¾—è¶Šæ¥è¶Šå¤§ã€è¶Šæ¥è¶Šå¤æ‚çš„ç¥žç»ç½‘ç»œæ¨¡åž‹å¾—ä»¥è®­ç»ƒã€‚åŒæ—¶ï¼ŒGPUæž¶æž„ [12, 36, 60] å·²æˆä¸ºæ”¯æŒDNNæ¨¡åž‹é«˜æ€§èƒ½æ‰§è¡Œçš„æœ€å¹¿æ³›ä½¿ç”¨çš„ç¡¬ä»¶ã€‚

å¦ä¸€æ–¹é¢ï¼Œ**DNNæ¨¡åž‹è§„æ¨¡å’Œå¤æ‚åº¦çš„å¢žé•¿å¯¹GPUå†…å­˜ç®¡ç†æå‡ºäº†æ–°çš„æŒ‘æˆ˜ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨CUDAçš„åŽŸç”Ÿå†…å­˜åˆ†é…APIå¦‚cudaMallocå’ŒcudaFreeä¼šå¸¦æ¥å·¨å¤§çš„å¼€é”€ã€‚ä¸ºäº†æé«˜GPUå†…å­˜åˆ†é…çš„æ•ˆçŽ‡ï¼ŒDLæ¡†æž¶é€‰æ‹©å®žçŽ°ä¸€ç§ç¼“å­˜åˆ†é…å™¨ï¼Œå®ƒä½¿ç”¨æœ€åˆé€‚çš„é€‚é…ä¸Žåˆå¹¶ï¼ˆBFCï¼‰ç®—æ³• [76] ç»´æŠ¤ä¸€ä¸ªå†…å­˜æ± ã€‚æˆ‘ä»¬çš„å®žéªŒè¡¨æ˜Žï¼Œç¼“å­˜åˆ†é…å™¨çš„æ€§èƒ½æ¯”åŽŸç”Ÿå†…å­˜åˆ†é…å™¨é«˜å‡ºè¿‘10å€ã€‚**

å¦ä¸€æ–¹é¢ï¼Œå¤§è§„æ¨¡DNNæ¨¡åž‹ [2, 75] å¯¹å†…å­˜éœ€æ±‚çš„è¿…é€Ÿå¢žé•¿å·²ç»å¼•å‘äº†åœ¨ç³»ç»Ÿçº§å’Œç®—æ³•çº§å‡è½»å†…å­˜éœ€æ±‚çš„æ–¹æ³•çš„å¼€å‘ã€‚**ä¾‹å¦‚ï¼Œé‡æ–°è®¡ç®— [40, 86]ã€å¸è½½ [69]ã€åˆ†å¸ƒå¼è®­ç»ƒ [28, 30, 42, 45, 72, 83] å’Œä½Žç§©é€‚åº” [29] ç­‰æ–¹æ³•ã€‚**å°½ç®¡è¿™äº›ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆé™ä½Žè®­ç»ƒæˆ–å¾®è°ƒå¤§è§„æ¨¡DNNæ¨¡åž‹çš„å†…å­˜å ç”¨ï¼Œä½†å®ƒä»¬å¯èƒ½å¯¼è‡´å†…å­˜åˆ©ç”¨æ•ˆçŽ‡ä½Žä¸‹ã€‚å…¶åŽŸå› åœ¨äºŽï¼Œ**è¿™äº›æ–¹æ³•åœ¨å†…å­˜åˆ†é…è¯·æ±‚ä¸­å¼•å…¥äº†å¤§é‡çš„ä¸è§„åˆ™æ€§å’ŒåŠ¨æ€æ€§ï¼Œå¯¼è‡´é«˜è¾¾30%çš„GPUå†…å­˜ç¢Žç‰‡åŒ–ã€‚**

![image-20240513121244821](../../_static/figure/image-20240513121244821.png)

å¦‚å›¾1å·¦ä¾§æ‰€ç¤ºï¼ŒDLæ¡†æž¶åœ¨å†…å­˜æ± ä¸­ç®¡ç†å†…å­˜åˆ†é…ã€‚å®ƒä»¬é‡‡ç”¨â€œåˆ†å‰²â€æ–¹æ³•ï¼Œå°†å†…å­˜æ± åˆ†å‰²ä»¥é€‚åº”DNNå¼ é‡çš„ä»»æ„å¤§å°ï¼Œæé«˜å†…å­˜æ± çš„åˆ©ç”¨çŽ‡ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•ä¼šå¯¼è‡´æŸäº›æ–°åˆ†é…çš„å†…å­˜äº§ç”Ÿä¸¥é‡çš„ç¢Žç‰‡åŒ–é—®é¢˜ã€‚**ä¾‹å¦‚ï¼Œæ¡†æž¶å°†ç¬¬ä¸‰è¡Œåˆ†å‰²ä»¥å­˜å‚¨æ–°åˆ†é…çš„Block 4ï¼Œä½†å†…å­˜æ± æ— æ³•å®¹çº³Block 6ï¼Œå› ä¸ºBlock 6çš„å¤§å°å¤§äºŽBlock 5ï¼Œå¯¼è‡´Block 5æ— æ³•åˆ©ç”¨å¹¶å˜æˆç¢Žç‰‡ã€‚**æœ€ç»ˆï¼Œ**æ¡†æž¶å°†æŠ¥å‘ŠDNNæ¨¡åž‹è®­ç»ƒè¿‡ç¨‹ä¸­æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€ï¼šå†…å­˜ä¸è¶³ï¼ˆOOMï¼‰é”™è¯¯ã€‚å‰è¿°çš„å†…å­˜å‡ç¼©æŠ€æœ¯å¦‚é‡æ–°è®¡ç®—å’Œå¸è½½å¯ä»¥ç¼“è§£OOMé—®é¢˜ï¼Œä½†ä¹Ÿä¼šå¯¼è‡´æ›´é¢‘ç¹å’Œä¸è§„åˆ™çš„å†…å­˜åˆ†é…ä¸Žé‡Šæ”¾è¯·æ±‚ï¼ŒåŠ å‰§ç¢Žç‰‡åŒ–é—®é¢˜ã€‚**

ä¸ºäº†ç¼“è§£GPUå†…å­˜ç¢Žç‰‡åŒ–å¹¶æé«˜å†…å­˜åˆ©ç”¨æ•ˆçŽ‡ï¼Œæœ¬ç ”ç©¶è‡´åŠ›äºŽ**æŽ¢ç´¢GPUå†…å­˜ç¢Žç‰‡åŒ–çš„åŽŸå› **ï¼Œå¹¶æå‡ºäº†ä¸€ç§åŸºäºŽ**ä½Žçº§GPUè™šæ‹Ÿå†…å­˜ç®¡ç†**çš„æ–°åž‹å†…å­˜åˆ†é…æ¡†æž¶ï¼Œç§°ä¸ºGPUå†…å­˜æ¹–ï¼ˆGMLakeï¼‰ï¼Œä»¥ä¼˜åŒ–GPUå†…å­˜ç®¡ç†å¹¶é™ä½Žå¼€é”€ã€‚å¦‚å›¾1å³ä¾§æ‰€ç¤ºï¼Œ**GMLakeé‡‡ç”¨äº†ä¸€ç§æ–°é¢–çš„è™šæ‹Ÿå†…å­˜æ‹¼æŽ¥ï¼ˆVMSï¼‰æœºåˆ¶ï¼Œä¸Žåˆ†å‰²æ–¹æ³•ä¼¼ä¹Žå‘ˆåå‘è¡Œä¸ºã€‚**ä¸ŽåŽŸå§‹æ¡†æž¶ç›¸æ¯”ï¼Œå®ƒå¯ä»¥é€šè¿‡è™šæ‹Ÿå†…å­˜åœ°å€æ˜ å°„å°†ä¸è¿žç»­çš„å†…å­˜å—èžåˆæˆ–ç»„åˆåœ¨ä¸€èµ·ã€‚ä¾‹å¦‚ï¼ŒVMSå¯ä»¥é€šè¿‡è™šæ‹Ÿå†…å­˜åœ°å€å°†Block 6æ˜ å°„åˆ°Block 2å’ŒBlock 5çš„æ‹¼æŽ¥å—ä¸­ï¼Œç„¶åŽå°†Block 6å­˜å‚¨åœ¨Block 2å’ŒBlock 5çš„ç‰©ç†å†…å­˜å—ä¸­**ã€‚æ˜¾ç„¶ï¼Œè™šæ‹Ÿå†…å­˜æ‹¼æŽ¥æœ‰æ•ˆå‡å°‘äº†å†…å­˜ç¢Žç‰‡åŒ–å¹¶æé«˜äº†å†…å­˜åˆ©ç”¨çŽ‡ã€‚æˆ‘ä»¬åœ¨DLæ¡†æž¶çš„ä½Žçº§å®žçŽ°äº†GMLakeï¼Œå¹¶æ›¿æ¢äº†DNNè®­ç»ƒçš„åŽŸå§‹å†…å­˜åˆ†é…APIã€‚**GMLakeå¯¹DNNæ¨¡åž‹å’Œå…¶ä»–å†…å­˜ä¼˜åŒ–æ–¹æ³•å¦‚é‡æ–°è®¡ç®—å’Œå¸è½½å®Œå…¨é€æ˜Žï¼Œç¡®ä¿èµ„æºå¯†é›†åž‹æ·±åº¦å­¦ä¹ ä»»åŠ¡çš„æ— ç¼æ‰§è¡Œã€‚

æ€»çš„æ¥è¯´ï¼Œè¿™é¡¹å·¥ä½œåšå‡ºäº†ä»¥ä¸‹è´¡çŒ®ï¼š

- æˆ‘ä»¬è¿›è¡Œäº†ä¸€é¡¹ç‰¹æ€§ç ”ç©¶ï¼Œä»¥å±•ç¤ºçŽ°æœ‰æ·±åº¦å­¦ä¹ æ¡†æž¶ä¸­ä½¿ç”¨çš„ç¼“å­˜åˆ†é…å™¨åœ¨è¿è¡Œå¤§è§„æ¨¡DNNæ¨¡åž‹æ—¶ï¼Œç»“åˆå„ç§å†…å­˜å‡å°‘æŠ€æœ¯ï¼ˆå¦‚é‡è®¡ç®—ã€å¸è½½ã€åˆ†å¸ƒå¼è®­ç»ƒå’Œä½Žç§©é€‚åº”ï¼‰ä¼šé­å—é«˜è¾¾30%çš„å†…å­˜ç¢Žç‰‡åŒ–ã€‚

- æˆ‘ä»¬è®¾è®¡å¹¶å®žçŽ°äº†ä¸€ç§åä¸ºGMLakeçš„æ–°åž‹å†…å­˜åˆ†é…å™¨ï¼Œæœ‰æ•ˆå‡å°‘å†…å­˜ç¢Žç‰‡åŒ–å¹¶æé«˜å†…å­˜åˆ©ç”¨çŽ‡ã€‚GMLakeå¯¹ä¸Šè¿°çŽ°æœ‰çš„å†…å­˜å‡å°‘æŠ€æœ¯æ˜¯é€æ˜Žçš„ã€‚å®ƒé€šè¿‡ä½¿ç”¨ä½Žçº§CUDAè™šæ‹Ÿå†…å­˜ç®¡ç†æœºåˆ¶æ•´åˆäº†è™šæ‹Ÿå†…å­˜æ‹¼æŽ¥æœºåˆ¶ã€‚

- æˆ‘ä»¬åœ¨å¤šä¸ªè‘—åçš„å¤§åž‹è¯­è¨€æ¨¡åž‹ï¼ˆLLMï¼‰ä¼˜åŒ–å¹³å°ä¸Šï¼Œä½¿ç”¨ä¸€ç»„ä»£è¡¨æ€§çš„å¼€æºLLMè¯„ä¼°GMLakeçš„æœ‰æ•ˆæ€§ã€æ•ˆçŽ‡å’Œç¨³å¥æ€§ã€‚åœ¨æœ€ä½³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†GPUå†…å­˜ä½¿ç”¨çŽ‡é™ä½Ž33%ï¼Œç›¸è¾ƒäºŽåœ¨å…·æœ‰80 GB HBMå†…å­˜çš„A100 GPUä¸Šä½¿ç”¨PyTorchåŽŸç”Ÿç¼“å­˜åˆ†é…å™¨ï¼ŒèŠ‚çœäº†25 GBçš„å†…å­˜ã€‚

## èƒŒæ™¯å’ŒåŠ¨æœº

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†æœ‰å…³æ·±åº¦å­¦ä¹ ï¼ˆDLï¼‰æ¡†æž¶å†…å­˜ç®¡ç†çš„åŸºæœ¬èƒŒæ™¯ï¼Œå¹¶é€šè¿‡æˆ‘ä»¬çš„å®žéªŒè§‚å¯Ÿæ¦‚è¿°äº†è¿›è¡Œæ­¤ç ”ç©¶çš„åŠ¨æœºã€‚

**é¦–å…ˆï¼Œæˆ‘ä»¬ç®€è¦æ¦‚è¿°äº†å¤§è§„æ¨¡DNNï¼ˆå¦‚LLMï¼‰çš„å¢žé•¿è¶‹åŠ¿ã€‚**

**éšåŽï¼Œæˆ‘ä»¬å¯¹å„ç§å†…å­˜ç®¡ç†æ–¹æ³•è¿›è¡Œäº†æ¯”è¾ƒåˆ†æžã€‚**

**æ¯”è¾ƒä¹‹åŽï¼Œæˆ‘ä»¬å‘çŽ°åœ¨åˆ†å¸ƒå¼è®­ç»ƒå’Œå†…å­˜é«˜æ•ˆä¼˜åŒ–ç­–ç•¥çš„èƒŒæ™¯ä¸‹ï¼ŒLLMsé¢ä¸´é‡å¤§çš„å†…å­˜ç¢Žç‰‡åŒ–æŒ‘æˆ˜ã€‚**

å› æ­¤ï¼Œæˆ‘ä»¬è¿«åˆ‡éœ€è¦å¼€å‘ä¸€ç§æ–°åž‹ä¸”é«˜æ•ˆçš„å†…å­˜åˆ†é…å™¨ï¼Œä»¥æœ‰æ•ˆåº”å¯¹è¿™äº›æŒ‘æˆ˜ã€‚

### 2.1 å¤§è§„æ¨¡DNNs

ä¾‹å¦‚OpenAIçš„GPTç³»åˆ—ä»£è¡¨äº†å¤§è§„æ¨¡DNNçš„æˆåŠŸï¼Œå¹¶åœ¨å„ç§è¯­è¨€å¤„ç†ä»»åŠ¡ä¸­å–å¾—äº†æ˜¾è‘—è¿›å±•ã€‚GPT-2åœ¨å…¶å‰èº«çš„åŸºç¡€ä¸Šå–å¾—äº†é‡å¤§è¿›å±•ï¼Œæ¨¡åž‹å¤§å°å’Œå¤æ‚æ€§å¢žåŠ äº†åå€[66]ï¼Œå…¶åŽæ˜¯GPT-3[7]æ‹¥æœ‰1750äº¿å‚æ•°ï¼Œä»¥åŠé’ˆå¯¹å¯¹è¯è¿›è¡Œå¾®è°ƒçš„ChatGPT[49]ã€‚
ç„¶è€Œï¼Œè¿™äº›æ¨¡åž‹çš„å¤§å°å’Œå¤æ‚æ€§å¸¦æ¥äº†åœ¨è®­ç»ƒå’Œéƒ¨ç½²ä¸­çš„é‡å¤§æŒ‘æˆ˜ã€‚å¯¹å¤§é‡è®¡ç®—èµ„æºã€æµ·é‡æ•°æ®å’Œå¤§é‡æ—¶é—´çš„éœ€æ±‚ï¼ˆä¾‹å¦‚ï¼ŒOPT-175B[87]ä½¿ç”¨1024ä¸ªA100 GPUè€—æ—¶34å¤©ï¼‰åŠ å‰§äº†å¯¹æœ‰æ•ˆè®­ç»ƒä¼˜åŒ–çš„å…³æ³¨ã€‚å› æ­¤ï¼Œæœ¬ç ”ç©¶å¼ºè°ƒäº†æœ‰æ•ˆå†…å­˜ç®¡ç†å¯¹**LLMè®­ç»ƒ**çš„é‡è¦æ€§ã€‚

### 2.2 DLæ¡†æž¶çš„å†…å­˜ç®¡ç†

åƒPyTorch [61] å’Œ TensorFlow [1] è¿™æ ·çš„æ¡†æž¶åœ¨DNNæ¨¡åž‹è®­ç»ƒå’ŒæŽ¨æ–­ä¸­æ‰®æ¼”ç€å…³é”®è§’è‰²ã€‚ä¸Žæ­¤åŒæ—¶ï¼ŒGPU [12, 36, 60] å·²æˆä¸ºé«˜æ€§èƒ½æ¨¡åž‹æ‰§è¡Œçš„é‡è¦ç¡¬ä»¶ã€‚æœ¬ç ”ç©¶èšç„¦äºŽè¿™äº›æµè¡Œæ¡†æž¶åœ¨GPUä¸Šçš„å†…å­˜ç®¡ç†ä¼˜åŒ–ã€‚æˆ‘ä»¬æ¯”è¾ƒäº†ä¸‰ç§ç±»åž‹çš„å†…å­˜ç®¡ç†ï¼š**GPUåŽŸç”Ÿåˆ†é…å™¨ã€ç¼“å­˜åˆ†é…å™¨å’Œè™šæ‹Ÿå†…å­˜ï¼ˆVMï¼‰åˆ†é…å™¨ã€‚**æˆ‘ä»¬è¿›è¡Œäº†å¤šæ¬¡å®žéªŒï¼Œä»¥æ˜¾ç¤ºæ¯ç§åˆ†é…å™¨ç›¸å…³çš„æ•ˆçŽ‡å’Œå¼€é”€ã€‚

![image-20240513142054166](../../_static/figure/image-20240513142054166.png)

**åŽŸç”Ÿåˆ†é…å™¨ã€‚**å¦‚å›¾2(a)æ‰€ç¤ºï¼ŒåŽŸç”Ÿåˆ†é…å™¨é€šè¿‡GPUä¾›åº”å•†æä¾›çš„APIsï¼Œå³cudaMallocå’ŒcudaFreeæä¾›ï¼Œéœ€è¦è®¾å¤‡åŒæ­¥ã€‚åŽŸç”Ÿåˆ†é…å™¨è®¾è®¡ç®€å•ï¼Œç¼ºä¹çµæ´»æ€§ã€‚**è¿™ä½¿å¾—å®ƒä¸é€‚åˆéœ€è¦åŠ¨æ€å’Œå¯è°ƒæ•´å¤§å°çš„å†…å­˜ç»“æž„æˆ–å¤æ‚å†…å­˜ç®¡ç†çš„åº”ç”¨ç¨‹åºï¼Œç‰¹åˆ«æ˜¯åœ¨DLçš„èƒŒæ™¯ä¸‹ã€‚**å¦‚æžœDLæ¡†æž¶åœ¨æ²¡æœ‰é€‚å½“åŒæ­¥ä¼˜åŒ–çš„æƒ…å†µä¸‹å®žçŽ°äº†åŽŸç”ŸGPUåˆ†é…å™¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´è®­ç»ƒDNNæ¨¡åž‹çš„ä¸å¯æŽ¥å—å¼€é”€ã€‚
æˆ‘ä»¬çš„å®žéªŒç»“æžœé‡åŒ–äº†åŽŸç”Ÿåˆ†é…å™¨çš„å¼€é”€ã€‚æˆ‘ä»¬ç¦ç”¨äº†PyTorchçš„ç¼“å­˜åˆ†é…å™¨ï¼ˆåœ¨ä¸‹ä¸€æ®µä¸­ä»‹ç»ï¼‰æ¥è®­ç»ƒå››ä¸ªA100-80G GPUä¸Šçš„OPT-1.3Bæ¨¡åž‹[87]ã€‚**PyTorchä¸­çš„åŽŸç”Ÿåˆ†é…å™¨ä¸ºç”¨æˆ·æä¾›äº†ç›¸åŒçš„ç¼–ç¨‹æ¨¡åž‹ï¼Œç”¨æˆ·å¯ä»¥æ›´æ”¹çŽ¯å¢ƒå˜é‡æ¥è®¾ç½®åˆ†é…å™¨ã€‚GPUåŽŸç”Ÿåˆ†é…å™¨çš„åžåé‡æ¯”åŽŸå§‹PyTorchåˆ†é…å™¨ä½Ž9.7å€ã€‚å› æ­¤ï¼Œæœ‰æ•ˆçš„å†…å­˜ç®¡ç†è®¾è®¡åº”è¯¥æ˜¯DLæ¡†æž¶ä¸­æœ€å…³é”®çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚**
**ç¼“å­˜åˆ†é…å™¨ã€‚**DLæ¡†æž¶é€šå¸¸ä½¿ç”¨å¸¦æœ‰å†…å­˜æ± çš„ç¼“å­˜åˆ†é…å™¨ï¼Œç”¨äºŽå¿«é€Ÿå†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œæ— éœ€è®¾å¤‡åŒæ­¥ã€‚å›¾2(b)æè¿°äº†PyTorchå’ŒTensorFlowä½¿ç”¨çš„ç¼“å­˜åˆ†é…å™¨ä¸­é‡‡ç”¨çš„BFCç®—æ³•[76]ã€‚PyTorchå’ŒTensorFlowçš„BFCå®žçŽ°å‡ ä¹Žç›¸åŒï¼Œæ•°æ®ç»“æž„ä¸Šæœ‰ç»†å¾®å·®åˆ«ã€‚
BFCç®—æ³•ä¸»è¦æœ‰å››ä¸ªæ“ä½œã€‚

1 å®ƒä»Žæœç´¢æœ€åˆé€‚çš„å·²åˆ†é…ä½†ä¸æ´»è·ƒçš„å†…å­˜å—å¼€å§‹ï¼Œç§°ä¸ºâ€œæœ€ä½³åŒ¹é…â€ã€‚å¦‚æžœæ²¡æœ‰åˆé€‚çš„å·²åˆ†é…å†…å­˜å—å€™é€‰ï¼Œç¼“å­˜åˆ†é…å™¨è°ƒç”¨åŽŸç”ŸGPUåˆ†é…å™¨APIsåˆ†é…æ–°çš„å†…å­˜å—ã€‚

2 å¦‚æžœè¯·æ±‚çš„å†…å­˜å°äºŽæœ€ä½³åŒ¹é…å—ï¼Œåˆ™ç®—æ³•å°†å—åˆ†ä¸ºä¸¤å—ä»¥æé«˜å†…å­˜åˆ©ç”¨çŽ‡ã€‚**å…¶ä¸­ä¸€ä¸ªåˆ†å‰²å—è¢«åˆ†é…ä»¥æ»¡è¶³å†…å­˜è¯·æ±‚ï¼Œè€Œå¦ä¸€ä¸ªä¿ç•™åœ¨å†…å­˜æ± ä¸­ä»¥ä¾›å°†æ¥é‡æ–°åˆ†é…ã€‚**ä¸ºæœ‰æ•ˆç®¡ç†å†…å­˜ï¼Œè¿™ä¸¤ä¸ªå—é€šè¿‡åŒå‘é“¾æŽ¥ç›¸äº’è¿žæŽ¥ï¼Œæ¯ä¸ªå—éƒ½ç›‘è§†å…¶ç›¸é‚»å—çš„å¯ç”¨çŠ¶æ€ã€‚

3 å¯¹äºŽé‡Šæ”¾ï¼ˆå›žæ”¶ï¼‰æ“ä½œï¼Œç®—æ³•ä¸è°ƒç”¨åŽŸç”ŸGPU API cuMemFreeï¼Œè€Œåªæ˜¯é‡Šæ”¾å¯¹å—çš„åˆ†é…ï¼ˆæŒ‡é’ˆï¼‰å¹¶å°†å—è®¾ç½®ä¸ºä¸æ´»è·ƒã€‚

4 æœ€åŽï¼Œç¼“å­˜åˆ†é…å™¨æ£€æŸ¥å·¦å³ç›¸é‚»çš„å—æ˜¯å¦ä¹Ÿæ˜¯ä¸æ´»è·ƒçš„ã€‚å¦‚æžœæ˜¯è¿™æ ·ï¼Œç¼“å­˜åˆ†é…å™¨å°†è¿™äº›ç›¸é‚»çš„ä¸æ´»è·ƒå—åˆå¹¶ä¸ºä¸€ä¸ªå—ã€‚

æ˜¾ç„¶ï¼Œç¼“å­˜åˆ†é…å™¨å¯ä»¥æ˜¾è‘—å‡å°‘å¯¹åŽŸç”ŸGPUå†…å­˜åˆ†é…å™¨APIsçš„è°ƒç”¨ã€‚**åœ¨æœ€ä½³æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å†…å­˜å—é€šè¿‡åŽŸç”Ÿåˆ†é…å™¨åˆ†é…å’Œå›žæ”¶ä»…ä¸€æ¬¡ã€‚**å› æ­¤ï¼Œç¼“å­˜åˆ†é…å™¨æ¯”åŽŸç”ŸGPUåˆ†é…å™¨æ›´æœ‰æ•ˆï¼Œå·²è¢«çŽ°æœ‰DLæ¡†æž¶å¹¿æ³›é‡‡ç”¨ã€‚**å¦ä¸€æ–¹é¢ï¼Œâ€œåˆ†å‰²â€æœºåˆ¶åœ¨å†…å­˜åˆ†é…è¯·æ±‚ä¸è§„åˆ™ä¸”å¤§å°ç›¸å·®å¾ˆå¤§æ—¶ä¼šå¼•å‘è®¸å¤šæ½œåœ¨çš„å†…å­˜ç¢Žç‰‡åŒ–é—®é¢˜ã€‚è¿™ä¸ªç¢Žç‰‡åŒ–é—®é¢˜ä»¥å‰å¹¶ä¸æ˜¾è‘—ï¼Œå› ä¸ºæ¨¡åž‹é€šå¸¸æ˜¯è§„åˆ™çš„ï¼Œå¤§å°ä¸å¤Ÿå¤§ã€‚**ä¾‹å¦‚ï¼ŒåŸºäºŽTransformerçš„æ¨¡åž‹[78]æ˜¯å¤šä¸ªç›¸åŒå±‚çš„å †å ï¼Œå…·æœ‰ç›¸åŒå¤§å°çš„å¼ é‡ï¼Œå¯¼è‡´å†…å­˜ç¢Žç‰‡åŒ–è¾ƒå°ã€‚**ç„¶è€Œï¼Œéšç€LLMçš„å¤§å°å¢žé•¿ï¼Œç”±äºŽåˆ†å¸ƒå¼è®­ç»ƒå’Œå¤æ‚çš„è®­ç»ƒå†…å­˜ç­–ç•¥ï¼Œç¢Žç‰‡åŒ–é—®é¢˜æ˜¾è‘—æ¶åŒ–ï¼Œå¯¼è‡´æ‰¹å¤„ç†å—é™å’Œå†…å­˜ç®¡ç†åŠè®­ç»ƒæ•ˆçŽ‡ä½Žä¸‹ã€‚**åœ¨æŽ¥ä¸‹æ¥çš„å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°è¿™äº›å¤æ‚è®­ç»ƒåœºæ™¯ä¸­çš„ç¢Žç‰‡åŒ–é—®é¢˜å˜å¾—å…·æœ‰æŒ‘æˆ˜æ€§ã€‚

### 2.3 å†…å­˜é«˜æ•ˆä¼˜åŒ–

å¤§è§„æ¨¡DNNæ¨¡åž‹çš„å†…å­˜éœ€æ±‚è¿…é€Ÿå¢žé•¿[2, 75]ï¼Œå‚¬ç”Ÿäº†åœ¨ç³»ç»Ÿå’Œç®—æ³•å±‚é¢å‡è½»å†…å­˜éœ€æ±‚çš„æ–¹æ³•å¼€å‘ã€‚è¿™äº›æ–¹æ³•çš„ä¾‹å­åŒ…æ‹¬é‡è®¡ç®—[40]ã€å¸è½½[69]å’Œä½Žç§©é€‚åº”[29]ã€‚é‡è®¡ç®—[40, 86]ï¼Œä¹Ÿç§°ä¸ºæ£€æŸ¥ç‚¹æŠ€æœ¯ï¼Œæ¶‰åŠåœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­é‡æ–°è®¡ç®—ç‰¹å®šå±‚çš„è¾“å‡ºï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ƒä»¬ï¼Œä»Žè€Œå®žçŽ°å†…å­˜èŠ‚çœã€‚å¸è½½ï¼ˆä¹Ÿç§°ä¸ºäº¤æ¢ï¼‰ï¼Œä¾‹å¦‚ZeRO-Offload [69]ï¼Œå°†**ä¼˜åŒ–å™¨å†…å­˜å’Œè®¡ç®—**ä»ŽGPUè½¬ç§»åˆ°CPUï¼Œä½¿å¾—åœ¨å•ä¸ªGPUä¸Šè®­ç»ƒå¤§åž‹æ¨¡åž‹å¹¶è·¨å¤šä¸ªGPUæ‰©å±•æˆä¸ºå¯èƒ½ã€‚é™¤äº†è¿™äº›ç³»ç»Ÿçº§æ–¹æ³•å¤–ï¼Œç®—æ³•æ–¹æ³•ä¹Ÿå¯ä»¥æœ‰æ•ˆåœ°å‡å°‘å†…å­˜éœ€æ±‚ã€‚ä¾‹å¦‚ï¼Œä¸ºå¤§è§„æ¨¡æ¨¡åž‹è®¾è®¡çš„LoRA [29]å¼•å…¥äº†ç§©åˆ†è§£çŸ©é˜µï¼Œä»¥æœ€å°åŒ–å¯è®­ç»ƒå‚æ•°å’ŒGPUå†…å­˜éœ€æ±‚ï¼Œå®žçŽ°ä¸Žå®Œæ•´æ¨¡åž‹å¾®è°ƒç›¸å½“çš„å‡†ç¡®æ€§ï¼ŒåŒæ—¶é™ä½Žæˆæœ¬å’Œæ—¶é—´ã€‚

![image-20240513142640301](../../_static/figure/image-20240513142640301.png)

![image-20240513142811142](../../_static/figure/image-20240513142811142.png)

ç„¶è€Œï¼Œå°½ç®¡è¿™äº›ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆå‡å°‘GPUå†…å­˜çš„å†…å­˜å ç”¨ï¼Œä½†æœ‰æ—¶å¯èƒ½å¯¼è‡´å†…å­˜åˆ©ç”¨çŽ‡ä½Žä¸‹ã€‚å¦‚å›¾3æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨å››ä¸ªA100-80G GPUä¸Šè®­ç»ƒOPT-1.3Bæ¨¡åž‹ï¼Œé‡‡ç”¨ä¸åŒçš„ä¼˜åŒ–æ–¹æ³•ç»„åˆã€‚ä»…ä½¿ç”¨PyTorch (P)æ—¶å®žçŽ°äº†é«˜å†…å­˜åˆ©ç”¨çŽ‡ï¼Œè€Œé‡‡ç”¨LoRA (L)ã€é‡è®¡ç®—(R)æˆ–å¸è½½(O)ç­‰æŠ€æœ¯æ˜¾è‘—é™ä½Žäº†å†…å­˜åˆ©ç”¨çŽ‡ã€‚æ ¹æ®æˆ‘ä»¬çš„è°ƒæŸ¥ï¼Œè¿™äº›æŠ€æœ¯çš„ç»„åˆå¯¼è‡´äº†é«˜å†…å­˜ç¢Žç‰‡åŒ–ã€‚åŽŸå› æ˜¯è¿™äº›å†…å­˜ä¼˜åŒ–æŠ€æœ¯æœ¬è´¨ä¸Šä¼šå¼•èµ·åŠ¨æ€å’Œä¸è§„åˆ™çš„åˆ†é…è¯·æ±‚ã€‚ä¸ºæŽ¢ç´¢è¿™ç§ä¸è§„åˆ™æ€§çš„æ¥æºï¼Œæˆ‘ä»¬å±•ç¤ºäº†åœ¨GPT-NeoX-20Bæ¨¡åž‹ä¸Šçš„è®­ç»ƒè¿‡ç¨‹çš„å†…å­˜å ç”¨ã€‚å¦‚å›¾5æ‰€ç¤ºï¼Œå·¦å›¾æ˜¾ç¤ºäº†åŽŸå§‹PyTorchçš„å ç”¨æƒ…å†µï¼Œå³å›¾æ˜¯åœ¨PyTorchä¸Šä½¿ç”¨LR (LoRAå’Œé‡è®¡ç®—)ä¼˜åŒ–åŽæ”¶é›†çš„æ•°æ®ã€‚æ˜¾ç„¶ï¼Œ**ç”±äºŽé‡‡ç”¨äº†å¦‚é‡è®¡ç®—ç­‰ä½¿ç”¨ç­–ç•¥ï¼Œå³å›¾æ˜¾ç¤ºçš„ä¸è§„åˆ™æ€§æ¯”å·¦å›¾æ›´æ˜Žæ˜¾ã€‚ç»Ÿè®¡ä¸Šï¼Œå·¦å›¾è¿›è¡Œäº†46åƒæ¬¡åˆ†é…ï¼Œå¹³å‡å¤§å°ä¸º93 MBï¼Œè€Œå³å›¾è¿›è¡Œäº†76åƒæ¬¡åˆ†é…ï¼Œå¹³å‡å¤§å°ä¸º85 MBï¼Œè¡¨æ˜Žå¤æ‚ç­–ç•¥å¯¼è‡´äº†æ›´é¢‘ç¹å’Œæ›´å°çš„åˆ†é…ï¼Œä»Žè€Œå¼•èµ·äº†ç¢Žç‰‡åŒ–ã€‚**
è¿™äº›ç»“æžœæ¿€åŠ±æˆ‘ä»¬è§£å†³å†…å­˜ç¢Žç‰‡åŒ–é—®é¢˜ï¼Œä»¥å®žçŽ°æ›´é«˜æ•ˆå’Œå¯æ‰©å±•çš„å¤§è§„æ¨¡DNNæ¨¡åž‹è®­ç»ƒã€‚
**è§‚å¯Ÿ1ï¼šä½¿ç”¨çš„å†…å­˜ä¼˜åŒ–ç­–ç•¥è¶Šå¤æ‚å’Œä¸è§„åˆ™ï¼Œç¢Žç‰‡åŒ–å°±è¶Šä¸¥é‡ã€‚**

### 2.4 åˆ†å¸ƒå¼è®­ç»ƒ

éšç€DNNæ¨¡åž‹å¤æ‚æ€§çš„å¢žåŠ ï¼Œåˆ†å¸ƒå¼è®­ç»ƒå˜å¾—è‡³å…³é‡è¦ï¼Œç‰¹åˆ«æ˜¯å¯¹äºŽLLMsã€‚ç”±PyTorchåˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œ(DDP)[43]æ”¯æŒçš„æ•°æ®å¹¶è¡Œæ€§ï¼Œå¤åˆ¶è®¾ç½®ä»¥åŒæ—¶å¤„ç†ä¸åŒéƒ¨åˆ†çš„æ•°æ®ï¼Œå¹¶åœ¨æ¯ä¸ªè®­ç»ƒæ­¥éª¤åŽåŒæ­¥ã€‚æ¨¡åž‹å¹¶è¡Œæ€§å°†æ¨¡åž‹åˆ†å¸ƒåœ¨å¤šä¸ªGPUä¸Šï¼Œæ¯ä¸ªGPUå¤„ç†ä¸åŒçš„é˜¶æ®µã€‚æ¨¡åž‹å¹¶è¡Œæ€§åŒ…æ‹¬ä¸¤ç±»ï¼šæµæ°´çº¿å¹¶è¡Œæ€§[42, 72, 83]ï¼Œåœ¨å•ä¸ªGPUä¸Šæ”¾ç½®å„ä¸ªå±‚ï¼Œä»¥åŠå¼ é‡å¹¶è¡Œæ€§[28, 30, 45]ï¼Œå°†æ¯ä¸ªå¼ é‡åˆ†æˆå—ï¼Œä¾›ç‰¹å®šGPUä½¿ç”¨ã€‚
æ˜¾ç„¶ï¼Œä½¿ç”¨æ›´å¤šGPUä¼šå› å…¶ä¸è§„åˆ™çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾è€Œå¯¼è‡´æ›´å¤šçš„ç¢Žç‰‡åŒ–ã€‚ä¸ºäº†æ£€éªŒè¿™ç§å½±å“ï¼Œæˆ‘ä»¬åœ¨PyTorchä¸Šå®žçŽ°äº†å¯¹OPT-13Bçš„æµ‹è¯•ã€‚å¦‚å›¾4æ‰€ç¤ºï¼Œå½“GPUæ•°é‡ä¸ºä¸€æ—¶ï¼Œå†…å­˜åˆ©ç”¨çŽ‡>90%ã€‚ç„¶è€Œï¼Œéšç€GPUæ•°é‡å¢žåŠ åˆ°16ä¸ªï¼Œå†…å­˜åˆ©ç”¨çŽ‡ä¸‹é™åˆ°76%ï¼Œå°½ç®¡å¤šGPUå¹¶è¡Œæ€§å¯¹äºŽè®­ç»ƒå¤§åž‹æ¨¡åž‹è‡³å…³é‡è¦ã€‚è¿™ç§ç¢Žç‰‡åŒ–æµªè´¹äº†å†…å­˜èµ„æºï¼Œé™åˆ¶äº†LLMè®­ç»ƒçš„æ‰¹é‡å¤§å°ã€‚
**è§‚å¯Ÿ2ï¼šéšç€GPUæ•°é‡çš„å¢žåŠ ï¼Œå†…å­˜ç¢Žç‰‡åŒ–é—®é¢˜å¯èƒ½ä¼šå˜å¾—æ›´åŠ æ˜Žæ˜¾ã€‚**

### 2.5 ä½Žçº§è™šæ‹Ÿå†…å­˜ï¼ˆVMï¼‰ç®¡ç†

**è€ƒè™‘åˆ°åº”ç”¨ç¨‹åºå¯¹å¿«é€Ÿé«˜æ•ˆåœ°ç®¡ç†å†…å­˜çš„éœ€æ±‚æ—¥ç›Šå¢žé•¿ï¼ŒCUDAå¼•å…¥äº†ä¸€é¡¹åä¸ºä½Žçº§è™šæ‹Ÿå†…å­˜ç®¡ç†[62]çš„æ–°åŠŸèƒ½ï¼Œç±»ä¼¼äºŽWindowsçš„VirtualAlloc[56]å’ŒLinuxçš„mmap[48]ã€‚è¿™ä¸€åŠŸèƒ½æ‰“ç ´äº†ç±»ä¼¼mallocçš„æŠ½è±¡ï¼Œæä¾›äº†è¯¸å¦‚é¢„ç•™å’Œæ˜ å°„ç­‰åŽŸå§‹æ“ä½œæ¥æ“æŽ§è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚åœ¨æˆ‘ä»¬çš„å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†è¿™ç§ä½Žçº§VMç®¡ç†å¦‚ä½•ç”¨äºŽå‡å°‘å†…å­˜ç¢Žç‰‡åŒ–å¹¶æé«˜å¤§è§„æ¨¡DNNè®­ç»ƒçš„å†…å­˜åˆ©ç”¨çŽ‡ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè™šæ‹Ÿå†…å­˜åˆ†é…å™¨ã€‚**

![image-20240513151203688](../../_static/figure/image-20240513151203688.png)

å›¾2(c)é˜é‡Šäº†ä½¿ç”¨è¿™ç§ä½Žçº§è™šæ‹Ÿå†…å­˜ç®¡ç†çš„åŸºæœ¬æ€æƒ³ã€‚cuMemAddressReserveå‡½æ•°ä¸ºæ–°çš„å†…å­˜åˆ†é…é¢„ç•™è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œè€ŒcuMemCreateåœ¨GPUä¸Šåˆ†é…ç‰©ç†å†…å­˜å—ã€‚**åº•å±‚ç³»ç»Ÿå¦‚ä½•åœ¨ç‰©ç†åœ°å€ç©ºé—´è½¬æ¢å†…å­˜å¹¶æ²¡æœ‰è¢«æŠ«éœ²ã€‚æ­¤å¤–ï¼Œå¹¶ä¸èƒ½ä¿è¯ç‰©ç†å—çš„è¿žç»­æ€§ã€‚cuMemMapå‡½æ•°è¿žæŽ¥ç‰©ç†å’Œè™šæ‹Ÿå†…å­˜ï¼Œå°†ç‰©ç†å¥æŸ„æ˜ å°„åˆ°é¢„ç•™åœ°å€ã€‚**CUDAè¿˜æä¾›äº†ä¸€ç³»åˆ—å†…å­˜é‡Šæ”¾å‡½æ•°ï¼Œå¦‚cuMemUnmapã€cuMemAddressFreeå’ŒcuMemReleaseã€‚æ˜¾ç„¶ï¼Œ**ä½Žçº§VM APIçš„ä¼˜åŠ¿åœ¨äºŽå®ƒå¯ä»¥åˆ†é…å¹¶æ˜ å°„éžè¿žç»­çš„ç‰©ç†å—ï¼Œè¿™å¯ä»¥è§£å†³GPUå†…å­˜ç¢Žç‰‡åŒ–é—®é¢˜**ã€‚ç„¶è€Œï¼Œè™šæ‹Ÿå†…å­˜åˆ†é…å™¨çš„å¼€é”€æ¯”åŽŸç”ŸGPUåˆ†é…å™¨è¦æ˜‚è´µå¾—å¤šã€‚

![image-20240513151338512](../../_static/figure/image-20240513151338512.png)

**ä¸ºéªŒè¯VMåˆ†é…å™¨çš„å¼€é”€ï¼Œæˆ‘ä»¬å¯¹ä¸‰ç§ä¸åŒå¤§å°çš„å†…å­˜åˆ†é…è¿›è¡Œäº†å®žéªŒï¼š512 MBã€1 GBå’Œ2 GBï¼Œè¿™äº›æ˜¯æ€»åˆ†é…å—å¤§å°ã€‚å›¾6å±•ç¤ºäº†åŽŸç”Ÿå†…å­˜åˆ†é…å™¨å’Œè™šæ‹Ÿå†…å­˜åˆ†é…å™¨ä¹‹é—´çš„æ¯”è¾ƒç»“æžœã€‚yè½´ä»£è¡¨åˆ†é…å»¶è¿Ÿï¼Œé‡‡ç”¨å¯¹æ•°åˆ»åº¦ã€‚xè½´ä¸Šçš„2 MBã€4 MBã€...ã€1024 MBä»£è¡¨æž„æˆåˆ†é…å—çš„å†…éƒ¨ç‰©ç†å—çš„å¤§å°ã€‚ä¾‹å¦‚ï¼Œ1 GBåˆ†é…å—éœ€è¦æ˜ å°„512ä¸ª2 MBå¤§å°çš„å—ã€‚æœ€ç»ˆï¼Œå›¾6çš„ç»“æžœæ˜¾ç¤ºè™šæ‹Ÿå†…å­˜çš„å»¶è¿Ÿæžé«˜ã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æžœè™šæ‹Ÿå†…å­˜å—è¢«åˆ†å‰²æˆ2 MBçš„å—ï¼Œå®ƒçš„é€Ÿåº¦ä¼šæ¯”åŽŸç”Ÿåˆ†é…å™¨æ…¢100å€ä»¥ä¸Šï¼Œè¿™æ˜¯å®Œå…¨æ— æ³•æŽ¥å—çš„ã€‚**

![image-20240513151654203](../../_static/figure/image-20240513151654203.png)

ä¸ºè¿›ä¸€æ­¥æŽ¢ç´¢VMM APIçš„ç“¶é¢ˆï¼Œæˆ‘ä»¬æä¾›äº†åˆ†é…çš„æ‰§è¡Œæ—¶é—´ç»†åˆ†ã€‚è¡¨1æ˜¾ç¤ºäº†ä½¿ç”¨2 GB GPUå†…å­˜åˆ†é…çš„VMM APIçš„å»¶è¿Ÿç»†åˆ†ã€‚æ‰€æœ‰å»¶è¿Ÿéƒ½å½’ä¸€åŒ–åˆ°cuMallocã€‚åœ¨GMLakeä¸­çš„æ¯æ¬¡åˆ†é…åªéœ€è¦ä¸€ä¸ªcuMemAddressReserveï¼Œä½†æ¯ä¸ªç‰©ç†å—éœ€è¦å¤šæ¬¡cuMemCreateã€cuMemMapå’ŒcuMemSetAccessã€‚cuMemSetAccessæ˜¯VMMæä¾›çš„ä¸€é¡¹ç‰¹æ®ŠåŠŸèƒ½ï¼Œç”¨äºŽä½¿æ˜ å°„å¯ç”¨ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨2 MBçš„å°å—æ¥åˆ†é…2 GBçš„å†…å­˜æ¯”åŽŸç”Ÿçš„cuMallocæ…¢115å€ã€‚
**è§‚å¯Ÿ3ï¼šè™½ç„¶è™šæ‹Ÿå†…å­˜å¯ä»¥å‡å°‘å†…å­˜ç¢Žç‰‡åŒ–ï¼Œä½†GPUä¸Šçš„åŽŸå§‹è™šæ‹Ÿå†…å­˜åˆ†é…å™¨ä»ç„¶å­˜åœ¨è®¸å¤šæŒ‘æˆ˜ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚**

## 3 GMLake

åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†GMLakeï¼Œä¸€ç§ä¸“ä¸ºGPUå†…å­˜ï¼ˆå³GPUå†…å­˜æ¹–ï¼‰è®¾è®¡çš„é«˜æ•ˆå†…å­˜åˆ†é…æ–¹æ³•ã€‚ 

**GMLake åˆ©ç”¨ CUDA çš„ä½Žçº§ VM ç®¡ç†åŠŸèƒ½æ¥åŠ å¿«å†…å­˜åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹ã€‚**

![image-20240513151952655](../../_static/figure/image-20240513151952655.png)

**å›¾ 7 æä¾›äº† GMLake çš„æ¦‚è¿°ï¼Œå®ƒä¸ºçŽ°æœ‰ç¼“å­˜åˆ†é…å™¨æä¾›ç›¸åŒçš„å†…å­˜ï¼ˆå–æ¶ˆï¼‰åˆ†é…æŽ¥å£ï¼Œä½†å†…éƒ¨é›†æˆäº†è™šæ‹Ÿå†…å­˜æ‹¼æŽ¥ (VMS) æœºåˆ¶ã€‚**

è¿™ç§é›†æˆæ˜¯é€šè¿‡ç²¾ç¡®åˆ©ç”¨ CUDA çš„ä½Žçº§ VM ç®¡ç† API æ¥å®žçŽ°çš„ã€‚

DLæ¡†æž¶ä¸­åŽŸå§‹çš„ç¼“å­˜åˆ†é…å™¨é‡‡ç”¨BFCç®—æ³•ï¼Œå¦‚2.2èŠ‚ä¸­æ‰€è¿°å’Œå›¾2(b)æ‰€ç¤ºã€‚

ä¸ºäº†é¿å…åŒæ­¥å¹¶æé«˜å†…å­˜ç®¡ç†æ•ˆçŽ‡ï¼Œè¿™äº›æ¡†æž¶åœ¨å†…éƒ¨ç®¡ç†å†…å­˜æ± æ¥å¤„ç†ï¼ˆå–æ¶ˆï¼‰åˆ†é…ï¼Œè€Œä¸æ˜¯ç›´æŽ¥ä½¿ç”¨æœ¬æœº APIã€‚

æŒ‰ç…§è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬çš„ GMLake è¿˜å…·æœ‰ä»¥ä¸‹ä¸‰ä¸ªç»„ä»¶ï¼š 

**è™šæ‹Ÿå†…å­˜ APIï¼šè¿™æ˜¯æŒ‡ç”¨äºŽæŒ‡ç¤º GPU ä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€åˆ†é…å’Œé‡Šæ”¾å†…å­˜çš„ä½Žçº§ APIï¼Œè¯¥è¿‡ç¨‹çš„ç‰¹ç‚¹æ˜¯å¦‚æžœæœªå®Œå…¨ä¼˜åŒ–ï¼Œåˆ™ä¼šäº§ç”Ÿå·¨å¤§çš„å¼€é”€ã€‚**

**è™šæ‹Ÿå†…å­˜æ± ï¼šä½œä¸ºåŸºç¡€æ•°æ®ç»“æž„ï¼Œæ—¨åœ¨ç¼“å­˜è™šæ‹Ÿå†…å­˜ã€‚å®ƒçš„å®žæ–½å¯¹äºŽæé«˜æ•ˆçŽ‡è‡³å…³é‡è¦ã€‚**

 **GMLake åˆ†é…å™¨ï¼šè¿™åŒ…æ‹¬ç®¡ç† VM æ± æ‰€å¿…éœ€çš„æ‰€æœ‰å‡½æ•°ã€ç®—æ³•å’Œç­–ç•¥ã€‚**

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°ä¸‰ä¸ªç»„æˆéƒ¨åˆ†çš„è®¾è®¡å’Œç»†èŠ‚ï¼Œå¹¶ä»ŽåŸºç¡€å±‚åˆ°æœ€é¡¶å±‚ç»„è£…GMLakeæ¡†æž¶ã€‚

### 3.1 è™šæ‹Ÿå†…å­˜ API

![image-20240513153327564](../../_static/figure/image-20240513153327564.png)

å¦‚ç¬¬2.5èŠ‚å’Œå›¾2(c)æ‰€ä»‹ç»çš„ï¼Œ**ä½Žçº§VMM APIæ˜¯GPUå’Œåº”ç”¨ç¨‹åºä¹‹é—´çš„åŸºæœ¬æŽ¥å£ã€‚**å¦‚å›¾8åº•éƒ¨æ‰€ç¤ºï¼Œ**æˆ‘ä»¬åˆ©ç”¨VMM APIæž„å»ºäº†GMLakeåˆ†é…å™¨ä¸­çš„åŸºæœ¬æ•°æ®ç»“æž„â€”â€”åŽŸå§‹å—ï¼ˆpBlockï¼‰ã€‚pBlockä¸­çš„æ“ä½œåŒ…æ‹¬ï¼š**

**AddrReserveï¼šé¦–å…ˆï¼ŒåŽŸå§‹å—çš„åˆ†é…éœ€è¦æŒ‡å®šåˆ†é…å¤§å°å¹¶é¢„ç•™ç›¸åº”çš„è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ã€‚**

**Createï¼šæŽ¥ä¸‹æ¥ï¼ŒåŽŸå§‹å—åˆ›å»ºå­˜å‚¨æ•°æ®çš„ç‰©ç†å—ã€‚**

**Mapï¼šæœ€åŽï¼ŒåŽŸå§‹å—å°†æ‰€æœ‰ç‰©ç†å—æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ï¼Œä½¿å¼ é‡èƒ½å¤Ÿæ— ç¼è®¿é—®ã€‚**

ä¸ºäº†ä¼˜åŒ–ç¢Žç‰‡æ•´ç†ï¼Œæˆ‘ä»¬åœ¨æ‰€æœ‰å—ä¸­åº”ç”¨ç»Ÿä¸€çš„2MBå—å¤§å°ã€‚**è™½ç„¶è¿™ç§2MBå—å¤§å°çš„å¼€é”€å¾ˆå¤§ï¼ˆå‚è§2.5èŠ‚ï¼‰ï¼Œä½†å¯ä»¥é€šè¿‡é«˜æ•ˆçš„æ•°æ®ç»“æž„å’Œç²¾å¿ƒè®¾è®¡çš„æ‹¼æŽ¥ç­–ç•¥æ¥å‡è½»ï¼Œè¿™ç§ç­–ç•¥èƒ½è¾¾åˆ°æœ€ä½³çš„ç¢Žç‰‡æ•´ç†æ•ˆæžœï¼Œå¹¶ä¸”ä¸ŽPyTorchä»£ç åº“æœ€å…¼å®¹ã€‚**

ä¸Žæ­¤åŒæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹é’ˆå¯¹DNNçš„ä¼˜åŒ–æ¥å‡å°‘æ‹¼æŽ¥çš„é¢‘çŽ‡ï¼Œä½¿å…¶ç«¯åˆ°ç«¯å¼€é”€å¾®ä¸è¶³é“ã€‚GMLakeä½¿ç”¨VMMå¤„ç†å¤§äºŽ2MBçš„åˆ†é…ã€‚**å¯¹äºŽå°äºŽ2MBçš„å†…å­˜åˆ†é…ï¼Œæˆ‘ä»¬ä½¿ç”¨åŽŸå§‹PyTorchç¼“å­˜åˆ†é…å™¨çš„åˆ†å‰²æ–¹æ³•æ¥å¤„ç†å…¶å†…éƒ¨ç¢Žç‰‡é—®é¢˜ã€‚æ­¤å¤–ï¼ŒLLMè®­ç»ƒä¸­å°äºŽ2MBçš„åˆ†é…å¾ˆå°‘è§ã€‚**

æ˜ å°„æ“ä½œæ˜¯è™šæ‹Ÿå†…å­˜æ‹¼æŽ¥çš„åŸºæœ¬æ“ä½œï¼Œå…è®¸æˆ‘ä»¬è¿žæŽ¥å¤šä¸ªç‰©ç†ä¸Šè¿žç»­ä½†åœ¨ç‰©ç†å†…å­˜ä¸­å¯èƒ½ä¸è¿žç»­çš„å—ã€‚åˆ©ç”¨VMM APIï¼Œæˆ‘ä»¬å¯ä»¥å°†è™šæ‹Ÿå†…å­˜ç¼–æŽ’åˆ°è™šæ‹Ÿå†…å­˜æ± ä¸­ï¼Œè¿™æ˜¯GMLakeåˆ†é…å™¨çš„åº•å±‚æ•°æ®ç»“æž„ã€‚è™šæ‹Ÿå†…å­˜æ± çš„è¯¦ç»†ä¿¡æ¯å¦‚ä¸‹æ‰€è¿°ã€‚

### 3.2 è™šæ‹Ÿå†…å­˜æ± 

é‰´äºŽåŽŸå§‹çš„VMM APIè€—æ—¶è¾ƒé•¿ï¼Œä¸ºäº†å®žçŽ°GMLakeçš„é«˜æ•ˆæ€§ï¼Œå‡å°‘å®ƒä»¬çš„ä½¿ç”¨è‡³å…³é‡è¦ã€‚å€Ÿé‰´ç¼“å­˜åˆ†é…å™¨çš„çµæ„Ÿï¼Œæˆ‘ä»¬è®¾è®¡äº†å…·æœ‰ç¼“å­˜åŠŸèƒ½çš„è™šæ‹Ÿå†…å­˜æ± ï¼ˆVMPï¼‰ï¼Œä»Žè€Œæ˜¾è‘—å‡å°‘äº†ç‰©ç†å†…å­˜ï¼ˆåˆ†é…å’Œé‡Šæ”¾ï¼‰çš„æ¬¡æ•°ã€‚**å¦‚å›¾8æ‰€ç¤ºï¼Œæˆ‘ä»¬åŒºåˆ†äº†ä¸¤ç§ç±»åž‹çš„å†…å­˜æ± ï¼šåŽŸå§‹å†…å­˜æ± ï¼ˆpPoolï¼‰å’Œæ‹¼æŽ¥å†…å­˜æ± ï¼ˆsPoolï¼‰ã€‚**

**pPool å’Œ pBlockã€‚**

pPoolçš„æ•°æ®ç»“æž„ä½¿ç”¨æŽ’åºé›†åˆæ¥å­˜å‚¨pBlocksã€‚å¯¹äºŽæ¯ä¸ªpBlockï¼ŒpPoolé¦–å…ˆæž„å»ºä¸€ä¸ªç»“æž„æ¥è®°å½•æŒ‡å‘pBlockçš„æŒ‡é’ˆï¼ŒåŒ…æ‹¬pBlockçš„åŸºæœ¬å±žæ€§ï¼Œå¦‚pBlockçš„æ´»åŠ¨çŠ¶æ€ã€‚éšåŽï¼Œæ–°åˆ†é…çš„pBlockè¢«æ’å…¥åˆ°é›†åˆä¸­ï¼Œæ‰€æœ‰pBlocksæŒ‰å—å¤§å°é™åºæŽ’åºã€‚**ä½œä¸ºåŽŸå§‹å—çš„pBlockä»£è¡¨é«˜çº§å¼ é‡å¯è®¿é—®çš„æœ€å°å•å…ƒï¼Œå®ƒå……å½“åŸºæœ¬æ•°æ®ç»“æž„ï¼Œå¯ä»¥è¢«å¤šä¸ªsBlocksæ‹¼æŽ¥å’ŒæŒ‡å‘ã€‚**

**sPool å’Œ sBlockã€‚**

**sPoolä¹Ÿè¢«ç»„ç»‡æˆä¸€ä¸ªæŽ’åºé›†åˆï¼Œä¸ŽpPoolç±»ä¼¼ã€‚**å…¶å…ƒç´ åŒ…æ‹¬æ‹¼æŽ¥å—ç»“æž„ï¼Œå®ƒæ•´åˆäº†å¤šä¸ªpBlocksã€‚ä¾‹å¦‚ï¼Œå¦‚å›¾8æ‰€ç¤ºï¼ŒsBlock 3åŒ…å«äº†pBlock 3å’Œ5ï¼Œè¿™ä¸¤ä¸ªè¢«æ‹¼æŽ¥åœ¨ä¸€èµ·ï¼ŒpBlock 3ä¹Ÿå¯èƒ½è¢«sBlock 2æŒ‡å‘å¹¶æ‹¼æŽ¥ã€‚**å› æ­¤ï¼ŒsBlockçš„å±žæ€§å—åˆ°pBlocksçš„å½±å“ï¼Œå¦‚æžœä»»ä½•ä¸€ä¸ªpBlockæ˜¯æ´»è·ƒçš„ï¼Œæ‰€æœ‰å¯¹åº”çš„sBlockséƒ½è¢«æ ‡è®°ä¸ºæ´»è·ƒã€‚**åœ¨å®žè·µä¸­ï¼ŒsBlockå°†è™šæ‹Ÿå†…å­˜é‡æ–°æ˜ å°„åˆ°æ‰€æŒ‡pBlocksçš„æ‰€æœ‰ç‰©ç†å—ï¼Œä½¿å…¶å¯ä»¥è¢«é«˜çº§å¼ é‡è®¿é—®ã€‚ä¸ºäº†ç®€åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä»¬è§„å®šsBlockåªèƒ½è¢«åˆ†é…æˆ–æŒ‡æ´¾ç»™ä¸ŽsBlockå¤§å°åŒ¹é…çš„å¼ é‡åˆ†é…ã€‚å…³äºŽè¿™ä¸€é™åˆ¶çš„æ›´å¤šç»†èŠ‚å°†åœ¨åŽç»­éƒ¨åˆ†æä¾›ã€‚

æ¯”è¾ƒç‰©ç†å—ã€pBlockå’ŒsBlockæ­ç¤ºäº†å®ƒä»¬ä½œä¸ºä¸åŒçº§åˆ«çš„æ•°æ®ç»“æž„çš„è§’è‰²ã€‚**è™½ç„¶ç‰©ç†å—ç”±ä½Žçº§APIæŽ§åˆ¶å¹¶å¯¹é«˜çº§å¼ é‡ä¿æŒé€æ˜Žï¼Œä½†pBlockå’ŒsBlockåˆ†åˆ«ä½äºŽpPoolå’ŒsPoolä¸­ï¼Œä¸ºé«˜çº§å¼ é‡è®¿é—®æä¾›è™šæ‹Ÿå†…å­˜åœ°å€ã€‚æ­¤å¤–ï¼ŒsBlockåœ¨æ›´é«˜çº§åˆ«ä¸Šæ“ä½œï¼Œç”±å¤šä¸ªpBlocksç»„æˆã€‚**æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æè¿°GMLakeå¦‚ä½•ä½¿ç”¨è¿™äº›æ•°æ®ç»“æž„æ¥å®žçŽ°é«˜æ•ˆçš„å†…å­˜ç®¡ç†ã€‚

### 3.3 åˆ†é…å™¨

åˆ†é…å™¨åŒ…æ‹¬æ‰€æœ‰å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ‰€éœ€çš„åŸºæœ¬åŠŸèƒ½å’Œç®—æ³•ã€‚ç”±äºŽç©ºé—´é™åˆ¶ï¼Œæˆ‘ä»¬åªç®€è¦è§£é‡Šåˆ†é…å’Œé‡Šæ”¾æ¨¡å—ä¸­ä½¿ç”¨çš„æœ€é‡è¦çš„åŠŸèƒ½ã€‚

#### 3.3.1 åˆ†é…æ¨¡å—ã€‚

**AllocåŠŸèƒ½è´Ÿè´£åˆ†é…æ–°çš„pBlockå¹¶å°†å…¶æ’å…¥pPoolï¼Œå¦‚å›¾8æ‰€ç¤ºã€‚**å®ƒä½œä¸ºåˆ†é…æ–°ç‰©ç†å—å’Œå¢žåŠ å·²åˆ†é…GPUå†…å­˜çš„å”¯ä¸€æŽ¥å£ã€‚

**SplitåŠŸèƒ½å°†ä¸€ä¸ªpBlockï¼ˆåŽŸå§‹å—ï¼‰åˆ†æˆä¸¤ä¸ªè¾ƒå°çš„pBlockï¼Œç±»ä¼¼äºŽå›¾2ä¸­æç»˜çš„â€œSplitâ€æ“ä½œï¼Œä½†åº•å±‚å®žçŽ°å®Œå…¨ä¸åŒã€‚**å…·ä½“æ¥è¯´ï¼Œ**GMLakeä¸­çš„SplitåŠŸèƒ½åŸºäºŽpBlockç»“æž„æ“ä½œï¼Œç”Ÿæˆä¸¤ä¸ªå…·æœ‰ç›¸åº”è™šæ‹Ÿå†…å­˜åœ°å€å’Œé‡æ–°æ˜ å°„çš„ç‰©ç†å—çš„æ–°pBlockã€‚**ä¹‹å‰çš„pBlockç»“æž„éšåŽä»ŽpPoolé›†åˆä¸­ç§»é™¤ã€‚

**StitchåŠŸèƒ½æ˜¯åˆ›å»ºä¸€ä¸ªsBlockå¹¶å°†å…¶æ’å…¥sPoolçš„å”¯ä¸€æœºåˆ¶ï¼Œå¦‚å›¾8é¡¶éƒ¨æ‰€ç¤ºã€‚**è¿™ä¸ªåŠŸèƒ½æ˜¯æˆ‘ä»¬åˆ†é…å™¨çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œ**å¯ä»¥å°†å¤šä¸ªpBlockæ‹¼æŽ¥æˆä¸€ä¸ªå•ç‹¬çš„sBlockã€‚**æˆ‘ä»¬ä½¿ç”¨VMM APIï¼Œå³NVIDIAä¸“é—¨ä¸ºè™šæ‹Ÿå†…å­˜ç®¡ç†ï¼ˆVMMï¼‰æä¾›çš„ä½Žçº§APIï¼Œæ¥â€œæ‹¼æŽ¥â€ä¸¤ä¸ªpBlockï¼Œå¦‚å›¾2(c)æ‰€ç¤ºã€‚**å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªpBlockï¼Œð‘1 (1GB) å’Œ ð‘2 (2GB)ã€‚æˆ‘ä»¬é‡‡ç”¨VMM API cuMemCreateæ¥åˆ›å»ºç›¸åº”çš„ç‰©ç†å—å¹¶é€šè¿‡cuMemAddressReserveé¢„ç•™è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ã€‚ç„¶åŽï¼ŒVAä½¿ç”¨cuMemMapæ˜ å°„PAã€‚å®žé™…ä¸Šï¼Œæˆ‘ä»¬ä¸éœ€è¦å–æ¶ˆåŽŸå§‹VA-PAæ˜ å°„ï¼Œå› ä¸ºPAåœ¨VMMä¸­å¯ä»¥è¢«å¤šä¸ªVAæŒ‡å‘ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªä½¿ç”¨cuMemAddressReserveä¸ºsBlock ð‘ 1é¢„ç•™3GBçš„VAã€‚å¯¹äºŽæ‰€æœ‰sBlocksï¼Œå®ƒä»¬ä»Žæœªåˆ›å»ºcuMemCreateæ–°çš„ç‰©ç†å—ã€‚æˆ‘ä»¬ä½¿ç”¨API cuMemMapå°†ð‘ 1 (3GB)çš„VAæ˜ å°„åˆ°ð‘1å’Œð‘2çš„ç‰©ç†å—ã€‚ç”±äºŽå¤šä¸ªsBlockså¯ä»¥åŒ…å«ç›¸åŒçš„ç‰©ç†å—ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„å±žæ€§æ¥ç¡®ä¿æ¯ä¸ªç‰©ç†å—åªè¢«ä¸€ä¸ªå¼ é‡ä½¿ç”¨ï¼Œå¦‚pBlockçš„æ´»è·ƒçŠ¶æ€ã€‚**

> 

![image-20240513155201853](../../_static/figure/image-20240513155201853.png)

BestFitåŠŸèƒ½è¯†åˆ«æœ€é€‚åˆå†…å­˜åˆ†é…çš„pBlockæˆ–sBlockï¼Œè¿”å›žçŠ¶æ€å’Œå€™é€‰å—ä»¥ä¾›åŽç»­å¤„ç†ã€‚å¦‚ç®—æ³•1æ‰€è¿°ï¼Œæˆ‘ä»¬è®¾è®¡äº†å››ç§çŠ¶æ€ï¼Œæ¶µç›–GMLakeå¯èƒ½é¢ä¸´çš„æ‰€æœ‰åœºæ™¯ã€‚å®ƒåŸºäºŽsPoolå’ŒpPoolæŒ‰å¤§å°é™åºæŽ’åºçš„å‡è®¾æ“ä½œã€‚

- **å®Œå…¨åŒ¹é…ï¼ˆç¬¬2-4è¡Œï¼‰ï¼šå½“å€™é€‰å—çš„å¤§å°ä¸Žåˆ†é…å¤§å°åŒ¹é…æ—¶ï¼Œä¼šå‡ºçŽ°è¿™ç§çŠ¶æ€ã€‚è¿™ä¸ªå—å¯èƒ½æ˜¯æ¥è‡ªsPoolçš„sBlockæˆ–æ¥è‡ªpPoolçš„pBlockã€‚è¿™æ˜¯sBlockå¯ä»¥è¢«åˆ†é…æ–°åˆ†é…çš„å”¯ä¸€æƒ…å†µã€‚æ‰€æœ‰å…¶ä»–çŠ¶æ€ä»…æ¶‰åŠpBlockã€‚**
- **å•ä¸€å—ï¼ˆç¬¬12è¡Œï¼‰ï¼šåœ¨è¿™é‡Œï¼ŒBestFitè¯†åˆ«å‡ºæœ€ä½³æ‹Ÿåˆï¼ˆæœ€å°ï¼‰çš„pBlockï¼Œå…¶å¤§å°å¤§äºŽè¯·æ±‚çš„åˆ†é…å¤§å°ã€‚**
- **å¤šä¸ªå—ï¼ˆç¬¬14è¡Œï¼‰ï¼šåœ¨æ‰€æœ‰pBlockséƒ½å°äºŽæ‰€éœ€åˆ†é…å¤§å°çš„æƒ…å†µä¸‹ï¼Œè€Œå®ƒä»¬çš„æ€»å¤§å°æ»¡è¶³åˆ†é…è¦æ±‚æ—¶ï¼ŒBestFitå‡½æ•°è´ªå©ªåœ°å¯»æ‰¾å¤šä¸ªå€™é€‰pBlockæ¥æ‹¼æŽ¥ã€‚**
- **ä¸è¶³å—ï¼ˆç¬¬16è¡Œï¼‰ï¼šå½“æ²¡æœ‰è¶³å¤Ÿçš„pBlocksæ»¡è¶³è¯·æ±‚çš„åˆ†é…å¤§å°æ—¶ï¼Œå°½ç®¡BestFitä»è¿”å›žä¸€ä¸ªå—åˆ—è¡¨ï¼Œå°±ä¼šå‡ºçŽ°è¿™ç§çŠ¶æ€ã€‚**

GMLakeæ›¿ä»£äº†PyTorchç¼“å­˜åˆ†é…å™¨æ¨¡å—çš„å‡ ä¸ªå†…éƒ¨å‡½æ•°ã€‚**"æ‹¼æŽ¥"æ“ä½œå¯¹ç”¨æˆ·å®Œå…¨é€æ˜Žï¼Œä¸ä¼šç»™ç”¨æˆ·å¸¦æ¥ä¿®æ”¹ä»£ç çš„è´Ÿæ‹…ã€‚**CUDA VMM APIæŒ‡çš„æ˜¯NVIDIAä¸“é—¨ä¸ºè™šæ‹Ÿå†…å­˜ç®¡ç†ï¼ˆVMMï¼‰æä¾›çš„ä½Žçº§APIã€‚**æˆ‘ä»¬é‡‡ç”¨çš„CUDA APIä¸ä»…åŒ…æ‹¬ä¸ŽVMMç›¸å…³çš„ï¼Œè¿˜åŒ…æ‹¬å¸¸è§„çš„å¦‚cuMemAllocç­‰ã€‚GMLake APIçš„å®žçŽ°åˆ©ç”¨CUDA APIå®žçŽ°äº†ç²¾ç»†çš„å†…å­˜æ‹¼æŽ¥å’Œé‡ç”¨ï¼Œå› æ­¤å®ƒä»¬å±žäºŽä¸åŒçš„çº§åˆ«å¹¶æä¾›ç›¸åº”çš„åŠŸèƒ½ã€‚**

#### 3.3.2 é‡Šæ”¾æ¨¡å—ã€‚

**é‡Šæ”¾æ¨¡å—é¿å…ä½¿ç”¨ä½Žçº§VMM APIä¸»åŠ¨é‡Šæ”¾ç‰©ç†GPUå†…å­˜ã€‚ç›¸åï¼Œå®ƒåªæ›´æ–°æˆ–æ¢å¤æ‹¼æŽ¥çš„è™šæ‹Ÿå†…å­˜å—ã€‚**

**æ›´æ–°ã€‚**åœ¨æŽ¥åˆ°é«˜çº§å¼ é‡çš„é‡Šæ”¾è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ç”¨æ›´æ–°å‡½æ•°æ›¿ä»£åŽŸå§‹VMMé‡Šæ”¾å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ›´æ”¹æ´»è·ƒpBlockså’ŒsBlocksçš„çŠ¶æ€ï¼Œä»Žè€Œå®žçŽ°ç§»é™¤å¼ é‡ä¸Žå—ä¹‹é—´çš„é“¾æŽ¥å’Œåˆ†é…ã€‚åœ¨æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´ï¼Œå®žé™…ç‰©ç†å†…å­˜ä»ç”±ç›¸åº”çš„pBlockæŽ§åˆ¶ã€‚

**StitchFreeã€‚**  **æ­¤åŠŸèƒ½çš„ç›®çš„æ˜¯é‡Šæ”¾sPoolä¸­ä¿å­˜çš„æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆLRUï¼‰çš„sBlocksã€‚**ç”±äºŽç©ºé—´é™åˆ¶ï¼Œæˆ‘ä»¬åœ¨æ­¤çœç•¥å¤æ‚çš„ç»†èŠ‚ã€‚æˆ‘ä»¬å·²å®žçŽ°å®Œæ•´çš„ç®—æ³•å’Œæ•°æ®ç»“æž„ä»¥æ”¯æŒåŸºäºŽLRUçš„StitchFreeã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åªä»ŽsPoolä¸­é‡Šæ”¾ä¸æ´»è·ƒçš„sBlockç»“æž„ã€‚

## 4 ç¢Žç‰‡æ•´ç†ç­–ç•¥

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å‡å°‘å†…å­˜ç¢Žç‰‡é—®é¢˜çš„ç­–ç•¥ã€‚æˆ‘ä»¬é¦–å…ˆæå‡ºäº†ä¸€ç§å¤æ‚çš„ç®—æ³•ï¼Œç†è®ºä¸Šå¯ä»¥æ¶ˆé™¤åŸºäºŽ GMLake åˆ†é…å™¨çš„æ‰€æœ‰ç¢Žç‰‡ã€‚ç„¶åŽæˆ‘ä»¬è®¨è®ºå¹¶æè¿°æˆ‘ä»¬çš„ä¼˜åŒ–ä»¥ä¿è¯å…¶æ•ˆçŽ‡å’Œç¨³å¥æ€§ã€‚

è¿™æ˜¯ä¸€ä¸ªå…³äºŽ GMLake å†…å­˜åˆ†é…ç­–ç•¥çš„è¯¦ç»†è§£é‡Šï¼Œä¸‹é¢æä¾›ä¸­æ–‡ç¿»è¯‘ï¼š

### 4.1 å†…å­˜åˆ†é…ç­–ç•¥

å›¾9æ˜¾ç¤ºäº† GMLake åˆ†é…ç­–ç•¥ï¼Œç”¨äºŽåˆ†é…æˆ–æŒ‡æ´¾ä¸€ä¸ªæ–°çš„å†…å­˜å—ç»™ä¸€ä¸ªæ–°çš„å¼ é‡åˆ†é…è¯·æ±‚ã€‚è¿™ä¸ªç­–ç•¥åŸºäºŽ BestFit æ¨¡å—æä¾›çš„å››ä¸ªçŠ¶æ€ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªçŠ¶æ€è®¾è®¡äº†ä¸€ä¸ªåŽå¤„ç†æ­¥éª¤ã€‚

![image-20240514162232732](../../_static/figure/image-20240514162232732.png)

> ### çŠ¶æ€ S1
>
> å½“ç³»ç»Ÿæ”¶åˆ°ä¸€ä¸ªæ–°çš„å†…å­˜åˆ†é…è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šåœ¨çŽ°æœ‰çš„å†…å­˜æ± ï¼ˆsPool å’Œ pPoolï¼‰ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰å·²ç»å­˜åœ¨çš„å†…å­˜å—å¯ä»¥ç›´æŽ¥ä½¿ç”¨ã€‚å¦‚æžœæ‰¾åˆ°äº†ä¸€ä¸ªå®Œå…¨åŒ¹é…çš„å—ï¼Œå°±ç›´æŽ¥ä½¿ç”¨å®ƒã€‚è¿™æ˜¯æœ€ç›´æŽ¥ã€æœ€å¿«çš„æ–¹å¼ã€‚
>
> ### çŠ¶æ€ S2
>
> å¦‚æžœåœ¨çŽ°æœ‰çš„å†…å­˜æ± ä¸­æ²¡æœ‰æ‰¾åˆ°å®Œå…¨åˆé€‚çš„å†…å­˜å—ï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸€ä¸ªå«åš BestFit çš„å‡½æ•°æ‰¾åˆ°ä¸€ä¸ªæœ€æŽ¥è¿‘çš„åŒ¹é…ï¼Œä½†è¿™ä¸ªå†…å­˜å—é€šå¸¸æ¯”éœ€è¦çš„ç¨å¤§ä¸€äº›ã€‚æ­¤æ—¶ï¼Œç³»ç»Ÿä¼šå°†è¿™ä¸ªè¾ƒå¤§çš„å†…å­˜å—åˆ†å‰²æˆä¸¤ä¸ªå°å—ï¼Œä¸€ä¸ªæ°å¥½æ»¡è¶³å½“å‰çš„éœ€æ±‚ï¼Œå¦ä¸€ä¸ªåˆ™æ”¾å›žå†…å­˜æ± ä»¥å¤‡åŽç”¨ã€‚åŒæ—¶ï¼Œç³»ç»Ÿä¼šå°è¯•å°†ä¸€äº›å°å—åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å—ï¼Œè¿™æœ‰åŠ©äºŽç®¡ç†å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚
>
> ### çŠ¶æ€ S3
>
> åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œä¸ºäº†æ»¡è¶³ä¸€ä¸ªæ›´å¤§çš„å†…å­˜éœ€æ±‚ï¼Œç³»ç»Ÿä¼šå°†å¤šä¸ªè¾ƒå°çš„å†…å­˜å—åˆå¹¶æˆä¸€ä¸ªè¶³å¤Ÿå¤§çš„å—ã€‚å¦‚æžœåˆå¹¶åŽçš„å—ä»ç„¶ä¸è¶³ä»¥æ»¡è¶³éœ€æ±‚ï¼Œç³»ç»Ÿå¯ä»¥å†æ¬¡å°†è¿™ä¸ªå¤§å—ç»†åˆ†ï¼Œä»¥ç¡®ä¿ç²¾ç¡®åŒ¹é…éœ€æ±‚ã€‚
>
> ### çŠ¶æ€ S4
>
> å¦‚æžœå‰é¢çš„æ‰€æœ‰å°è¯•éƒ½æ— æ³•æ»¡è¶³å†…å­˜éœ€æ±‚ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ä¸€ä¸ªåº•å±‚çš„åˆ†é…å‡½æ•°ï¼ˆAllocï¼‰ï¼Œå°è¯•ä»Žè®¡ç®—æœºçš„ç‰©ç†å†…å­˜ä¸­èŽ·å–æ–°çš„å†…å­˜å—ã€‚è¿™ä¸ªæ–°èŽ·å–çš„å†…å­˜å—å°†è¢«åŠ å…¥åˆ°å†…å­˜æ± ä¸­ã€‚åŒæ—¶ï¼Œå¦‚æžœå¯èƒ½ï¼Œç³»ç»Ÿä¼šç»§ç»­å°è¯•å°†å·²æœ‰çš„å†…å­˜å—åˆå¹¶ï¼Œä»¥åˆ›å»ºä¸€ä¸ªæ›´å¤§çš„å†…å­˜å—æ¥æ»¡è¶³éœ€æ±‚ã€‚å¦‚æžœåœ¨è¿™ä¸ªé˜¶æ®µä¹Ÿæ²¡æœ‰åˆé€‚çš„å†…å­˜å—å¯ä»¥ä½¿ç”¨ï¼Œç³»ç»Ÿä¼šè¿”å›žä¸€ä¸ªå†…å­˜ä¸è¶³çš„é”™è¯¯ï¼ˆOOMï¼‰ã€‚

åœ¨çŠ¶æ€ S1 ä¸­ï¼Œå¦‚æžœåœ¨éžæ´»åŠ¨çš„ sPool å’Œ pPool ä¸­æ²¡æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„å—ï¼Œåˆ™ç«‹å³è¿”å›žçŽ°æœ‰çš„ pBlock æˆ– sBlock ç”¨äºŽåˆ†é…1ã€‚

ç„¶åŽï¼Œæˆ‘ä»¬åœ¨ BestFit å‡½æ•°äº§ç”Ÿçš„å•ä¸ªå—çš„æŒ‡å¯¼ä¸‹ï¼Œè¿›å…¥çŠ¶æ€ S2ã€‚

è¿™éœ€è¦å°†è¾ƒå¤§çš„ pBlock 1 åˆ†å‰²ï¼ˆé€šè¿‡ Splitï¼‰æˆä¸¤ä¸ªç‹¬ç«‹çš„ pBlocksï¼Œéƒ½æ’å…¥åˆ° pPool ä¸­ã€‚

æ–°åˆ›å»ºçš„ pBlock 1 æ›¿æ¢å…¶å‰ä»»ï¼Œå¹¶ä¸ºåˆ†é…2åˆ†é…ã€‚

åŒæ—¶ï¼ŒGMLake æ‰§è¡Œä¸€ä¸ª Stitch å‡½æ•°ï¼Œå°† pBlock 1 å’Œ pBlock 2 åˆå¹¶æˆ sBlock 1ï¼Œç„¶åŽå°†å…¶æ·»åŠ åˆ° sPool ä¸­ã€‚

åœ¨çŠ¶æ€ S3 ä¸­ï¼ŒGMLake é€šè¿‡åˆå¹¶ï¼ˆStitchï¼‰å¤šä¸ª pBlocks æ¥åˆ›å»ºç”¨äºŽåˆ†é…3çš„åˆå¹¶åŽçš„ sBlock 3ã€‚

å¦‚æžœéœ€è¦ï¼Œå¯ä»¥åƒåœ¨ S2 ä¸­é‚£æ ·å°†æœ€ç»ˆçš„ pBlock ç»†åˆ†ï¼ˆSplitï¼‰ã€‚

è¿™ä¸€é˜¶æ®µä»¥å°†ç‰¹å®šçš„ pBlock 4 å’Œ pBlock 5 å¼•å…¥ pPoolï¼ŒåŒæ—¶å°† sBlock 2 å’Œ sBlock 3 æ·»åŠ åˆ° sPool ä¸­è€Œç»“æŸã€‚

åœ¨çŠ¶æ€ S4 ä¸­ï¼Œå¦‚æžœå¯ç”¨äºŽç¼åˆå’Œåˆ†é…çš„å—ä¸è¶³ä»¥æ»¡è¶³åˆ†é…4çš„éœ€è¦ï¼ŒGMLake åˆ™è§¦å‘ Alloc å‡½æ•°ï¼Œä½¿ç”¨ä½Žçº§ API åˆ›å»ºå…·æœ‰æ–°çš„ç‰©ç†å—å’Œç›¸åº”çš„è™šæ‹Ÿå†…å­˜åœ°å€çš„ pBlock 7ã€‚

è¿™ä¸ªæ–°çš„ pBlock è¢«æ·»åŠ åˆ° pPool ä¸­ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬é€šè¿‡ Stitch åˆå¹¶ pBlock 5 å’Œ pBlock 7 æˆä¸ºä¸€ä¸ªæ–°çš„ sBlock 4ï¼Œå®ƒè¢«è¿”å›žç”¨äºŽåˆ†é…4ï¼Œå¹¶æ·»åŠ åˆ° sPool ä¸­ã€‚å¦‚æžœæ²¡æœ‰åˆé€‚çš„å€™é€‰å—å­˜åœ¨ï¼ˆå³ï¼Œä¸å­˜åœ¨ pBlock 5ï¼‰ï¼ŒGMLake ç›´æŽ¥åˆ†é… pBlock 7ï¼Œä¸ä½¿ç”¨ Stitch å‡½æ•°ã€‚

å¦‚æžœ Alloc å‡½æ•°è°ƒç”¨å¤±è´¥ï¼ŒGMLake ä¼šç«‹å³åœ¨çŠ¶æ€ S5 æŠ¥å‘Šå†…å­˜ä¸è¶³ï¼ˆOOMï¼‰é”™è¯¯ã€‚

### 4.2 ç­–ç•¥åˆ†æž
æˆ‘ä»¬ä»Žæ•ˆæžœã€æ•ˆçŽ‡å’Œé²æ£’æ€§æ–¹é¢åˆ†æž GMLake çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚
#### 4.2.1 æ•ˆæžœ
GMLake çš„åˆ†é…ç­–ç•¥æœ‰æ•ˆåœ°ç¡®ä¿å‡ ä¹Žæ¶ˆé™¤äº† GPU ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç¢Žç‰‡ã€‚
**æŽ¥å£ï¼š**è¿™ç§ç­–ç•¥çš„æœ‰æ•ˆæ€§å¾—åˆ°äº†æˆ‘ä»¬æŽ¥å£è®¾è®¡çš„å¸®åŠ©ï¼Œè¯¥è®¾è®¡å°†æ‰€æœ‰æ“ä½œæ•´åˆè¿›ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼šAllocã€Split å’Œ Stitchã€‚Alloc æ˜¯å”¯ä¸€å¯ä»¥åˆ›å»ºæ–°çš„ pBlock çš„åŠŸèƒ½ï¼Œè€Œåªæœ‰ Stitch å¯ä»¥ç”Ÿæˆæ–°çš„ sBlockï¼Œè€Œ Split åˆ™ä¸å¢žåŠ å·²åˆ†é…çš„å†…å­˜ã€‚
**æ•°æ®ç»“æž„ï¼špPool è¡¨ç¤º GPU å†…å­˜çš„ä¸¥æ ¼ä¸€å¯¹ä¸€æ˜ å°„ï¼Œæ¯ä¸ª pBlock éƒ½ä¸Žå…¶ä»–çš„ä¸åŒã€‚å®ƒæ˜¯ä¸€ä¸ªæ²¡æœ‰é‡å¤å…ƒç´ å’Œé‡å åœ°å€çš„å·²åˆ†é… GPU å†…å­˜é›†ã€‚sPool è¢«è®¾è®¡ä¸ºå­˜å‚¨ sBlocksï¼Œä¿ç•™æŒ‡å‘ pBlocks çš„é“¾æŽ¥å’ŒæŒ‡é’ˆï¼Œç±»ä¼¼äºŽè½¯é“¾æŽ¥æœºåˆ¶ã€‚GMLake ç¦æ­¢åˆ†å‰² sBlocksï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå½±å“ pBlocksã€‚sPool è¢«è§†ä¸º pPool çš„ä¸€ä¸ªå­é›†ã€‚**
æœ€åŽï¼Œæ¯æ¬¡ç¨‹åºè¾¾åˆ° GPU å†…å­˜ä½¿ç”¨çš„æ–°é«˜å³°æ—¶ï¼Œä¾‹å¦‚è°ƒç”¨ Alloc å‡½æ•°æ—¶ï¼ŒpPool å¯èƒ½æ— æ³•æä¾›è¶³å¤Ÿçš„å—è¿›è¡Œç¼åˆå’Œåˆ†é…ï¼Œä»Žè€Œå®žçŽ°å…¨å†…å­˜åˆ©ç”¨è€Œæ²¡æœ‰ç¢Žç‰‡ã€‚è¿™ä¸ŽåŽŸå§‹çš„ç¼“å­˜åˆ†é…å™¨ä¸åŒï¼ŒåŽè€…å¯èƒ½ä¼šç•™ä¸‹è®¸å¤šæœªä½¿ç”¨çš„å­å—ã€‚

#### 4.2.2 æ•ˆçŽ‡

æˆ‘ä»¬é‡‡ç”¨äº†å‡ ç§æ–¹æ³•æ¥å®žçŽ°é«˜æ•ˆçŽ‡ã€‚æœ€åˆï¼ŒS3 ä¸­çš„ç®—æ³•é—®é¢˜ä»£è¡¨äº†ä¸€ä¸ªç»å…¸çš„ NP-hard æ‰“åŒ…é—®é¢˜ [55]ã€‚ç„¶è€Œï¼Œé€šè¿‡åº”ç”¨ Split å’Œ Stitch åŠŸèƒ½ï¼Œç”Ÿæˆä¸€ä¸ªå®Œå…¨åŒ¹é…çš„å—ä»¥é€‚åº”åˆ†é…ï¼Œå¯¼è‡´çº¿æ€§å¤æ‚åº¦ã€‚
å…¶æ¬¡ï¼Œç”± sPool å’Œ pPool ç»„æˆçš„è”åˆé›†è®°å½•äº†æ¯ä¸ªå¼ é‡åˆ†é…çš„æ‰€æœ‰å¤§å°å’Œç›¸åº”å—ï¼Œç±»ä¼¼äºŽè®°å½• DNN æ¨¡åž‹è®­ç»ƒçš„å¼ é‡åˆ†é…æ¨¡å¼çš„ç£å¸¦ã€‚**å¹¸è¿çš„æ˜¯ï¼ŒDNN æ¨¡åž‹è®­ç»ƒé«˜åº¦è§„èŒƒåŒ–ï¼Œå› ä¸ºæ¯æ¬¡è¿­ä»£éƒ½å¤„ç†ç›¸åŒçš„æ¨¡åž‹å‚æ•°å’Œè¾“å…¥æ•°æ®å¤§å°ã€‚å› æ­¤ï¼Œç»è¿‡å‡ æ¬¡è¿­ä»£åŽï¼ŒGMLake å°†ä¸å†æ‰§è¡Œ S2ã€S3 å’Œ S4ã€‚GMLake åªä¼šåœ¨è®­ç»ƒçš„å…¶ä½™æ—¶é—´ä½¿ç”¨ S1 çš„â€œå®Œå…¨åŒ¹é…â€ç­–ç•¥ï¼Œä¸ŽåŽŸå§‹çš„ç¼“å­˜åˆ†é…å™¨ä¸åŒï¼ŒåŽè€…ä¸æ–­éœ€è¦åˆ†å‰²å’Œåˆå¹¶æ“ä½œã€‚**

> ### é«˜æ•ˆçš„å†…å­˜ç®¡ç†ç­–ç•¥
>
> åœ¨ GMLake ç³»ç»Ÿä¸­ï¼Œå†…å­˜ç®¡ç†é¢ä¸´ä¸€ä¸ªéžå¸¸å¤æ‚çš„é—®é¢˜ï¼Œç±»ä¼¼äºŽéœ€è¦å°†ä¸åŒå¤§å°çš„ç‰©å“ï¼ˆåœ¨è¿™é‡Œæ˜¯æ•°æ®å—ï¼‰å°½å¯èƒ½å®Œç¾Žåœ°æ”¾å…¥ä¸€ä¸ªç®±å­ä¸­ï¼ˆå†…å­˜ç©ºé—´ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªè¢«ç§°ä¸º NP-hard çš„å¤æ‚é—®é¢˜ï¼Œé€šå¸¸å¾ˆéš¾æ‰¾åˆ°å®Œç¾Žçš„è§£å†³æ–¹æ¡ˆã€‚
>
> ä¸ºäº†å¤„ç†è¿™ä¸ªé—®é¢˜ï¼ŒGMLake ä½¿ç”¨äº†ä¸¤ç§ä¸»è¦çš„æ“ä½œï¼š
> 1. **Splitï¼ˆåˆ†å‰²ï¼‰**ï¼šå¦‚æžœä¸€ä¸ªå†…å­˜å—å¤ªå¤§ï¼Œå®ƒä¼šè¢«åˆ†å‰²æˆæ›´å°çš„å—ï¼Œä»¥ç²¾ç¡®åŒ¹é…æ‰€éœ€çš„å¤§å°ã€‚
> 2. **Stitchï¼ˆç¼åˆï¼‰**ï¼šå¦‚æžœæœ‰å‡ ä¸ªå°å—ï¼Œå®ƒä»¬å¯ä»¥è¢«åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å—ï¼Œä»¥æ»¡è¶³æ›´å¤§çš„éœ€æ±‚ã€‚
>
> è¿™äº›æ“ä½œå¸®åŠ©ç³»ç»Ÿä»¥çº¿æ€§çš„å¤æ‚åº¦æ¥ç®¡ç†å†…å­˜ï¼Œè¿™æ„å‘³ç€å³ä½¿åœ¨å¤„ç†å¾ˆå¤šå†…å­˜å—æ—¶ï¼Œç³»ç»Ÿçš„é€Ÿåº¦ä¹Ÿä¸ä¼šæ…¢å¾—ç¦»è°±ã€‚
>
> ### è®°å½•å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨
> ç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è®°å½•æœºåˆ¶ï¼Œå®ƒä¼šè®°å½•æ‰€æœ‰çš„å†…å­˜å—åˆ†é…æƒ…å†µï¼Œå°±åƒä¸€ä¸ªè®°å½•è®¾å¤‡ä¸€æ ·ã€‚è¿™æœ‰åŠ©äºŽç³»ç»Ÿè®°ä½å“ªäº›å†…å­˜å—è¢«ä½¿ç”¨è¿‡ï¼Œä»¥åŠå®ƒä»¬è¢«æ€Žæ ·ä½¿ç”¨ã€‚
>
> ### ä¼˜åŒ–æ·±åº¦å­¦ä¹ æ¨¡åž‹è®­ç»ƒ
> åœ¨æ·±åº¦å­¦ä¹ ï¼ˆDNNï¼‰æ¨¡åž‹è®­ç»ƒä¸­ï¼Œæ•°æ®å¤„ç†çš„éœ€æ±‚é€šå¸¸æ˜¯å›ºå®šçš„ï¼Œå› ä¸ºæ¯æ¬¡è¿­ä»£å¤„ç†çš„æ¨¡åž‹å‚æ•°å’Œè¾“å…¥æ•°æ®å¤§å°éƒ½æ˜¯ä¸€æ ·çš„ã€‚å› æ­¤ï¼Œç»è¿‡å‡ æ¬¡è®­ç»ƒè¿­ä»£ä¹‹åŽï¼Œç³»ç»Ÿä¼šå­¦ä¹ åˆ°æ•°æ®çš„æ¨¡å¼ï¼Œèƒ½å¤Ÿé¢„æµ‹å¹¶ä¼˜åŒ–å†…å­˜çš„åˆ†é…ã€‚è¿™æ„å‘³ç€ç³»ç»Ÿä¸éœ€è¦å†é¢‘ç¹åœ°è¿›è¡Œå¤æ‚çš„åˆ†å‰²å’Œåˆå¹¶æ“ä½œã€‚å®ƒä¼šå°½å¯èƒ½åœ°é‡ç”¨å·²ç»åˆ†é…å¥½çš„å†…å­˜å—ï¼Œè¿™å¤§å¤§æé«˜äº†æ•ˆçŽ‡ã€‚
>
> æ€»çš„æ¥è¯´ï¼ŒGMLake ç³»ç»Ÿé€šè¿‡æ™ºèƒ½åœ°è®°å½•å’Œé¢„æµ‹å†…å­˜ä½¿ç”¨éœ€æ±‚ï¼Œå‡å°‘äº†ä¸å¿…è¦çš„æ“ä½œï¼Œä»Žè€Œä½¿å†…å­˜ç®¡ç†æ›´åŠ é«˜æ•ˆå’Œç¨³å®šã€‚

#### 4.2.3 é²æ£’æ€§
åœ¨å®žè·µä¸­ï¼Œç”±äºŽ GPU çš„æ€»å®¹é‡é™åˆ¶ï¼Œç¼åˆå’Œåˆ›å»ºæ–°çš„ sBlocks ä¸èƒ½æ— é™è¿›è¡Œã€‚æ­¤å¤–ï¼Œè¿‡å¤šçš„ç¼åˆæ“ä½œå¯èƒ½ä¼šæŸå®³ GMLake åˆ†é…å™¨åœ¨ sPool ä¸Šè¿è¡Œåˆ†é…æ¨¡å—çš„æ•ˆçŽ‡ï¼Œä¾‹å¦‚ BestFitã€‚å½“æ€»å®¹é‡è¶…è¿‡è¿™ä¸ªé™åˆ¶æˆ–é˜ˆå€¼æ—¶ï¼ŒGMLake é‡‡ç”¨ StitchFree æ¥é‡Šæ”¾æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ sBlocks å¹¶æ¸…é™¤æ¨¡å¼ç£å¸¦ï¼Œä»Žè€Œä½œä¸ºé²æ£’æ€§çš„å›žé€€æœºåˆ¶ã€‚
æ­¤å¤–ï¼Œå½“ DNN è®­ç»ƒå±•çŽ°å‡ºæžå…¶ä¸è§„åˆ™çš„æ¨¡å¼æ—¶ï¼Œå¯èƒ½ä¼šç”Ÿæˆå¤§é‡å°å—ï¼Œå¯¼è‡´é¢‘ç¹çš„åˆ†å‰²å’Œç¼åˆï¼Œä»Žè€Œæå‰è¾¾åˆ°é™åˆ¶ã€‚ä¸ºé¿å…ä¸å¿…è¦çš„æ€§èƒ½æŸå¤±ï¼Œå»ºç«‹äº†æœ€å°ç¢Žç‰‡é™åˆ¶ã€‚å¦‚æžœä¸€ä¸ªå—å°äºŽè¿™ä¸ªé™åˆ¶ï¼ŒGMLake å°†é¿å…ç¼åˆæˆ–åˆ†å‰²å®ƒã€‚å› æ­¤ï¼Œæ‰€æœ‰ç®—æ³•å’Œæ¨¡å—éƒ½éµå®ˆç¢Žç‰‡é™åˆ¶ï¼ˆä¾‹å¦‚ï¼Œ128 MBï¼‰ï¼Œä»¥ç¡®ä¿ DNN è®­ç»ƒçš„é«˜æ•ˆçŽ‡å’Œé²æ£’æ€§ã€‚

## 5 å®žéªŒ

![image-20240514163900602](../../_static/figure/image-20240514163900602.png)

> å¤æ‚çš„ç­–ç•¥ä¼šå¯¼è‡´ç¢Žç‰‡åŒ–ã€‚å›¾ 10 æ˜¾ç¤ºäº†åˆ©ç”¨çŽ‡å’Œä¿ç•™å†…å­˜æ¶ˆè€—ã€‚ç»¼åˆæ¥çœ‹ï¼Œä¸Ž PyTorch ç›¸æ¯”ï¼Œåˆ©ç”¨çŽ‡çš„å¢žåŠ å’Œä¿ç•™å†…å­˜çš„å‡å°‘åˆ†åˆ«çº¦ä¸º 5% è‡³ 24%ï¼ˆæˆ–çº¦ä¸º 10 GB è‡³ 17 GBï¼‰ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒGMLake æœ‰æ•ˆåœ°å°†ç¢Žç‰‡çŽ‡é™ä½Žåˆ° 5% åˆ° 10%ï¼Œä»Žè€Œç¼“è§£äº†ç¢Žç‰‡é—®é¢˜ã€‚
>
> å½“é‡‡ç”¨å¤æ‚çš„ä¼˜åŒ–ç­–ç•¥æ—¶ï¼ŒPyTorch ä¸Šçš„ç¢Žç‰‡çŽ‡å¯èƒ½ä¼šè¶…è¿‡ 20%ã€‚åº”ç”¨è¿™äº›ä¼˜åŒ–ç­–ç•¥ä¸Žä¸åº”ç”¨è¿™äº›ä¼˜åŒ–ç­–ç•¥ä¹‹é—´çš„åˆ©ç”¨çŽ‡å¯¹æ¯”å˜å¾—æ˜¾è€Œæ˜“è§ã€‚ä¸ºäº†è¯´æ˜Žè¿™ä¸€ç‚¹ï¼Œè¯·è€ƒè™‘é‡æ–°è®¡ç®—ç­–ç•¥ï¼šå®ƒåœ¨å‰å‘ä¼ é€’æœŸé—´ä¸¢å¼ƒæ¿€æ´»å¼ é‡çš„ä¸€éƒ¨åˆ†ã€‚è¿™å¼•å…¥äº†æ›´é«˜é¢‘çŽ‡çš„å°å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ“ä½œï¼Œæœ€ç»ˆå¯¼è‡´ç¢Žç‰‡ã€‚å¸è½½ç­–ç•¥ä¹Ÿå‡ºçŽ°äº†ç±»ä¼¼çš„æƒ…å†µï¼Œå¼ é‡åœ¨ CPU å†…å­˜å’Œ GPU å†…å­˜ä¹‹é—´é¢‘ç¹æ¢å…¥æ¢å‡ºï¼Œè¿›ä¸€æ­¥å¢žåŠ å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ“ä½œçš„é¢‘çŽ‡ã€‚è¿™ç§æƒ…å†µå‡¸æ˜¾äº†GMLakeçš„éœ€æ±‚å’Œç‰¹ç‚¹ï¼šå®ƒçš„è®¾è®¡æ˜¯é€æ˜Žä¸”æœ‰æ•ˆçš„ï¼Œå¯¹äºŽé‚£äº›æ—¥ç›Šå¤æ‚çš„ä¼˜åŒ–ç­–ç•¥ã€‚

![image-20240514164117270](../../_static/figure/image-20240514164117270.png)

> GPU æ¨ªå‘æ‰©å±•ä¼šå¯¼è‡´ç¢Žç‰‡ã€‚è™½ç„¶å·¨å¤§çš„é›†ç¾¤åŠ é€Ÿäº†è®­ç»ƒè¿‡ç¨‹ï¼Œä½†å®ƒä»¬ä¹Ÿå¸¦æ¥äº†è¶Šæ¥è¶Šå¤šçš„ GPU å†…å­˜ç¢Žç‰‡ã€‚å›¾ 11 å±•ç¤ºäº†å½“ GPU æ•°é‡ä»Ž 1 ä¸ªå¢žåŠ åˆ° 16 ä¸ªæ—¶åˆ©ç”¨çŽ‡é€æ¸ä¸‹é™ã€‚å°½ç®¡å­˜åœ¨æŸäº›å¼‚å¸¸å€¼ï¼Œä½†è¯¥å›¾æ˜¾ç¤º PyTorch çš„ç¢Žç‰‡çŽ‡æœ‰æ‰€å¢žå¤§ã€‚è¯¦ç»†æ¥è¯´ï¼Œåˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œç­–ç•¥å¯¼è‡´äº†è¿™ä¸€è¶‹åŠ¿ã€‚ DeepSpeed ZeRO-3 [67] æ„å‘³ç€å¯¹ä¼˜åŒ–çŠ¶æ€ã€æ¢¯åº¦å’Œæƒé‡è¿›è¡Œåˆ†åŒºã€‚å½“æ›´å¤šçš„GPUå‚ä¸Žè®­ç»ƒæ—¶ï¼Œä¸Šè¿°å¼ é‡å¤§å°ä¼šæ›´å°ã€‚å®ƒä¼šå¯¼è‡´è®¸å¤šå¤§å—åˆ†è£‚å¹¶å¯¼è‡´æ›´å¤šçš„å†…å­˜ç¢Žç‰‡æ•´ç†ã€‚å¦‚å›¾11åº•éƒ¨æ‰€ç¤ºï¼ŒGMLakeåŒæ ·ä¿æŒç€é«˜åžåé‡ï¼Œ

![image-20240514164207005](../../_static/figure/image-20240514164207005.png)

> å„ç§å¹³å°ä¸Šçš„å¯æ‰©å±•æ€§ã€‚æˆ‘ä»¬åˆ©ç”¨åŒ…æ‹¬ Deepspeed [68]ã€FSDP [89] å’Œ Colossal-AI [44] åœ¨å†…çš„å„ç§å¹³å°å¯¹ OPT-13B [87]ã€GLM-10B [17] å’Œ GPT-2 [66] è¿›è¡Œå¾®è°ƒæ¨¡åž‹ï¼Œåˆ†åˆ«ã€‚è¯¥è¿‡ç¨‹é‡‡ç”¨é™æ€ä¼˜åŒ–ç­–ç•¥ï¼Œç‰¹åˆ«æ˜¯ LoRA å’Œé‡æ–°è®¡ç®—ï¼Œå¹¶æ¶‰åŠä½¿ç”¨å››ä¸ª NVIDIA A100 (80 GB) GPUã€‚å¦‚å›¾ 12 æ‰€ç¤ºï¼Œç»“æžœè¡¨æ˜Žç¢Žç‰‡å’Œä¿ç•™å†…å­˜å‡æ˜¾ç€å‡å°‘ï¼Œå‡å°‘èŒƒå›´åˆ†åˆ«ä¸ºçº¦ 9% è‡³ 33%ï¼Œä»¥åŠä»Ž 7 GB è‡³ 25 GBã€‚è¿™äº›ç»“æžœè¯å®žäº† GMLake åœ¨å„ç§ä¼˜åŒ–çš„è®­ç»ƒå¹³å°ä¸Šè¡¨çŽ°å‡ºçš„é«˜å¯æ‰©å±•æ€§.

![image-20240514164429580](../../_static/figure/image-20240514164429580.png)

> å›¾ 13 æ˜¾ç¤ºï¼Œåœ¨ 1.3 åˆ° 200 äº¿ä¸ªå‚æ•°çš„æ¨¡åž‹å¤§å°èŒƒå›´å†…ï¼ŒGMLake å§‹ç»ˆè¡¨çŽ°å‡ºå³°å€¼å†…å­˜æ¶ˆè€—çš„å¤§å¹…é™ä½Žã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§å†…å­˜æ¶ˆè€—ç¼“è§£éšç€æ¨¡åž‹å¤§å°çš„å¢žåŠ è€Œè¡¨çŽ°å‡ºå¯æ‰©å±•æ€§ï¼ŒåŒæ—¶ä¿æŒä¸€è‡´çš„æ‰¹é‡å¤§å°ã€‚

![image-20240514163442778](../../_static/figure/image-20240514163442778.png)

> **å†…å­˜è¿½è¸ªåˆ†æž**
>
> æœ€ç»ˆï¼Œæˆ‘ä»¬åœ¨ PyTorch å’Œ GMLake ä¸­ï¼Œåˆ©ç”¨ LoRA å’Œé‡æ–°è®¡ç®—ç­–ç•¥ï¼Œè¿½è¸ªäº† 4 ä¸ª GPU ä¸Š GPT-NeoX-20B çš„å†…å­˜åˆ†é…è¡Œä¸ºï¼Œå¦‚å›¾ 14 æ‰€ç¤ºã€‚
>
> æœ‰ä¸‰ä¸ªå€¼å¾—æ³¨æ„çš„ç‚¹çªå‡ºäº† GMLake çš„ä¼˜åŠ¿ã€‚é¦–å…ˆï¼Œç”±äºŽå†…å­˜æº¢å‡ºï¼ˆOOMï¼‰å¼‚å¸¸ï¼ŒPyTorch åœ¨å¤§çº¦ 200 ç§’æ—¶ç»ˆæ­¢ï¼Œè€Œ GMLake å¯¹è¿™ä¸ªæ‰¹å¤§å°èƒ½æ­£å¸¸è¿è¡Œã€‚å…¶æ¬¡ï¼Œå°½ç®¡ GMLake å’Œ PyTorch çš„æ´»è·ƒå†…å­˜æ°´å¹³ç›¸åŒï¼Œä½†ä»–ä»¬ä¿ç•™çš„å†…å­˜å·®å¼‚å¾ˆå¤§ï¼Œè¿™è¡¨æ˜Ž PyTorch å­˜åœ¨è¾ƒå¤§çš„ç¢Žç‰‡é—®é¢˜ã€‚
>
> ç¬¬ä¸‰ï¼Œä»Ž 100 ç§’åˆ° 400 ç§’æœŸé—´ï¼ŒPyTorch å’Œ GMLake çš„æ´»è·ƒå†…å­˜å®šæœŸæ³¢åŠ¨ï¼Œæ˜¾ç¤ºäº† LLM å¾®è°ƒé˜¶æ®µçš„å†…å­˜æ¨¡å¼ï¼Œç‰¹åˆ«æ˜¯åœ¨å‰å‘å’ŒåŽå‘ä¼ é€’ä¸­ã€‚æ´»è·ƒå†…å­˜çš„å¢žåŠ ä»£è¡¨å‰å‘ä¼ é€’çš„å†…å­˜åˆ†é…ï¼Œè€Œæ´»è·ƒå†…å­˜çš„å‡å°‘åˆ™ä»£è¡¨åŽå‘ä¼ é€’ã€‚ä¸¤ä¸ªç›¸ä¼¼æ¨¡å¼ä¹‹é—´çš„é—´éš”åæ˜ äº†ä¸€æ¬¡å•ç‹¬è¿­ä»£çš„æ—¶é—´æˆæœ¬ã€‚
>
> æœ€åŽï¼Œåœ¨å››æ¬¡è¿­ä»£åŽï¼ŒGMLake è¾¾åˆ°ç¨³å®šå¹¶å®žçŽ°äº†ä¸Ž PyTorch ç›¸åŒçš„åžåé‡ã€‚è¿™è¡¨æ˜Ž GMLake ä¸­ä½¿ç”¨çš„åˆ†é…ç­–ç•¥èƒ½å¤Ÿå¿«é€Ÿé€‚åº”å‰å‘/åŽå‘è®­ç»ƒä¼ é€’ä¸­çš„å†…å­˜æ³¢åŠ¨ï¼Œå¹¶æ‰¾åˆ°æœ€ä½³çš„ç¼“å­˜å’Œç¼åˆç­–ç•¥ã€‚
>
> æˆ‘ä»¬åˆ©ç”¨ DNN è®­ç»ƒçš„å‘¨æœŸæ€§ç‰¹å¾ã€‚å›¾ 14 æ˜¾ç¤ºï¼Œ**DNN è®­ç»ƒåœ¨è®­ç»ƒä¸­æœ‰ä¸€ä¸ªç¨³å®šçš„å‘¨æœŸï¼Œç±»ä¼¼çš„ VMM åˆ†é…è¯·æ±‚é‡å¤å‡ºçŽ°ã€‚è¿™ç§å‘¨æœŸæ€§æä¾›äº†é‡ç”¨ç¼åˆçš„ sBlocks çš„æœºä¼šï¼Œåˆ†æ‘Šå…¶æˆæœ¬ã€‚ä¸ºäº†å®žçŽ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨ GMLake ä¸­è®¾è®¡äº†ç¼åˆå†…å­˜æ± ï¼ˆsPoolï¼‰æ¥è¦†å†™ sBlocksã€‚å½“åˆ›å»ºä¸€ä¸ªæ–°çš„ sBlock æ—¶ï¼Œæˆ‘ä»¬å°†å…¶æ·»åŠ åˆ° sPool ä¸­ã€‚å½“ sBlock è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬ä»ä¿æŒå…¶å­˜åœ¨ã€‚ä¸‹æ¬¡éœ€è¦åˆ›å»ºç›¸åŒçš„ sBlock æ—¶ï¼Œå¯ä»¥ç›´æŽ¥é‡ç”¨ä¹‹å‰åˆ›å»ºçš„ sBlockã€‚åªè¦æˆ‘ä»¬ç»´æŠ¤è¶³å¤Ÿçš„ sPool å®žä¾‹ï¼Œæ‰€æœ‰åˆ†é…åªéœ€æœç´¢å…¶æœ€ä½³é€‚é…çš„ sBlockï¼Œè€Œæ— éœ€åˆ›å»ºæ–°çš„ sBlockã€‚æˆ‘ä»¬ç§°ä¹‹ä¸ºæ”¶æ•›ï¼Œ**ä¾‹å¦‚ï¼Œå›¾ 14 ä¸­çš„å››æ¬¡è¿­ä»£åŽã€‚

## 6 ç›¸å…³å·¥ä½œä¸Žè®¨è®º

æˆ‘ä»¬ä»Žä¸¤ä¸ªæ–¹é¢å°† GMLake ä¸ŽçŽ°æœ‰çš„å·¥ä½œè¿›è¡Œæ¯”è¾ƒï¼šå†…å­˜ç¢Žç‰‡æ•´ç†å’Œå¤§åž‹è¯­è¨€æ¨¡åž‹ï¼ˆLLMsï¼‰çš„å†…å­˜ä¼˜åŒ–ã€‚

**å†…å­˜ç¢Žç‰‡æ•´ç†**ã€‚

> **å†…å­˜ç¢Žç‰‡æ•´ç†å·²åœ¨å¤šç§çŽ¯å¢ƒä¸­è¢«å¹¿æ³›ç ”ç©¶ã€‚**
>
> The memory fragmentation problem: Solved?  1998
>
> EDDY: A multi-core BDD package with dynamic memory management and reduced fragmentation. 2023 ACM
>
> **ä¸ºäº†è§£å†³ä¸Žç¢Žç‰‡ç›¸å…³çš„æŒ‘æˆ˜ï¼Œæ—©æœŸæ–‡çŒ®æå‡ºäº†ä¸€ç§ä½¿ç”¨ç»†ç²’åº¦å›ºå®šå¤§å°å—çš„ç›´æŽ¥æ–¹æ³•ã€‚è™½ç„¶è¿™ç§æ–¹æ³•æ¶ˆé™¤äº†æ•°æ®ç§»åŠ¨çš„å¼€é”€ï¼Œä½†å®ƒå¢žåŠ äº†è®¿é—®çš„å¼€é”€å¹¶é™åˆ¶äº†çµæ´»æ€§ã€‚**
>
> Eliminating external fragmentation in a non-moving garbage collector for java.
>
> **ä¸ºäº†æé«˜æ•ˆçŽ‡å’Œçµæ´»æ€§ï¼Œç ”ç©¶äººå‘˜æå‡ºäº†åŸºäºŽåŽ‹ç¼©çš„ç­–ç•¥ï¼Œä¾‹å¦‚é€šè¿‡æ•°æ®ç§»åŠ¨å°†å¤šä¸ªå°å—åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„è¿žç»­å•å…ƒã€‚**
>
> openjdk. The z garbage collector.
>
> Parallel memory defragmentation on a GPU.  2012 ACM
>
> **å…¶ä»–ç¢Žç‰‡æ•´ç†æŠ€æœ¯ï¼ŒåŒ…æ‹¬åŸºäºŽå¤åˆ¶çš„åžƒåœ¾æ”¶é›†ç³»ç»Ÿï¼Œå‡å°‘äº†æ•°æ®ç§»åŠ¨é€»è¾‘çš„å¤æ‚æ€§ï¼Œä½†ä»¥æš‚æ—¶çš„å†…å­˜æµªè´¹ä¸ºä»£ä»·ã€‚**
>
> Sapphire: copying GC without stopping the world.
>
> Parallel generational-copying garbage collection with a block-structured heap
>
> Improving locality with parallel hierarchical copying GC
>
> **è™½ç„¶ä¸Žå°†å°å—åˆå¹¶æˆæ›´å¤§å—åœ¨æ¦‚å¿µä¸Šæœ‰äº›ç›¸ä¼¼ï¼Œä½† GMLake é‡‡ç”¨äº†åŸºäºŽç¼åˆçš„æŠ€æœ¯ï¼Œæœ€å°åŒ–äº†é¢‘ç¹æ•°æ®ç§»åŠ¨å’Œå¤åˆ¶çš„éœ€è¦ï¼Œæ˜¾è‘—æé«˜äº†å†…å­˜æ•ˆçŽ‡ã€‚é™¤äº†ä¼ ç»Ÿçš„å†…å­˜ç³»ç»Ÿï¼Œæœ€è¿‘çš„ç ”ç©¶è¿˜æŽ¢è®¨äº†æŒä¹…æ€§å†…å­˜çš„ç¢Žç‰‡æ•´ç†ã€‚**

**é«˜æ•ˆçš„å¤§åž‹è¯­è¨€æ¨¡åž‹ï¼ˆLLMï¼‰**ã€‚å¯¹äºŽåŸºäºŽ Transformer çš„ LLMsï¼Œå†…å­˜å·²æˆä¸ºè®¡ç®—ç³»ç»Ÿä¸­çš„è‡³å…³é‡è¦èµ„æºã€‚æ³¨æ„åŠ›æœºåˆ¶çš„äºŒæ¬¡æ€§è´¨å¯¼è‡´ LLMs çš„å†…å­˜æ¶ˆè€—å¤§å¹…å¢žåŠ ï¼Œä»Žè€Œæ”¾å¤§äº†æœ‰æ•ˆå†…å­˜ç®¡ç†çš„é‡è¦æ€§ã€‚ç ”ç©¶äººå‘˜æå‡ºäº†å„ç§æ—¨åœ¨é™åˆ¶å†…å­˜æ¶ˆè€—çš„ç®—æ³•ä¼˜åŒ–ï¼ŒåŒ…æ‹¬é‡åŒ–æŠ€æœ¯ã€å‰ªæžç­–ç•¥å’Œ KV ç¼“å­˜åŽ‹ç¼©æ–¹æ³•ã€ç¼–è¯‘å’Œè°ƒåº¦ã€‚æœ‰å„ç§ç³»ç»Ÿçº§çš„å†…å­˜ä¼˜åŒ–ã€‚vLLM å·¥ä½œåˆ©ç”¨åŸºäºŽé¡µé¢çš„è™šæ‹Ÿå†…å­˜ç®¡ç†æŠ€æœ¯å¤§å¹…æé«˜èµ„æºæ•ˆçŽ‡å’ŒæœåŠ¡åžåé‡ã€‚FlashAttention é‡‡ç”¨å¹³é“ºæŠ€æœ¯ä¼˜åŒ–æ³¨æ„åŠ›è®¡ç®—å¹¶æ˜¾è‘—å‡å°‘å†…å­˜æ¶ˆè€—ã€‚FlexGen æ¡†æž¶å¼•å…¥äº†ä¸€ç§ä¼˜åŒ–ç­–ç•¥ï¼Œä»¥ç¡®å®šæœ€ä¼˜çš„å†…å­˜-è®¡ç®—å®‰æŽ’ï¼Œä»¥å®žçŽ°é«˜æ•ˆçš„æµæ°´çº¿æ‰§è¡Œã€‚åœ¨è¿™ä¸€èƒŒæ™¯ä¸‹ï¼ŒGMLake ä½œä¸ºä¸€ä¸ªç”¨æˆ·é€æ˜Žçš„å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œåè°ƒæ™ºèƒ½å’Œé«˜æ•ˆçš„å†…å­˜é‡ç”¨ã€‚

> **KV ç¼“å­˜åŽ‹ç¼©**
>
> Unlimiformer: Long-range transformers with unlimited length input.
>
> Reformer: The efficient transformer.
>
> **Offload**
>
> Efficient combination of rematerialization and offloading for training dnns
>
> **ç¼–è¯‘**
>
> TVM: an automated end-to-end optimizing compiler for deep learning
>
> TASO: optimizing deep learning computation with automatic generation of graph substitutions
>
> Ansor: Generating High-Performance Tensor Programs for Deep Learning
>
> ugrapher: High-performance graph operator computation via unified abstraction for graph neural networks
>
> ROLLER: Fast and efficient tensor compilation for deep learning. 
>
> **è°ƒåº¦**
>
> Lazy batching: An sla-aware batching system for cloud machine learning inference
>
> Nesting forward automatic differentiation for memory-efficient deep neural network training
>
> VELTAIR: towards high-performance multi-tenant deep learning services via adaptive compilation and scheduling
>
> Heracles: improving resource efficiency at scale
>
> Bubble-up: increasing utilization in modern warehouse scale computers via sensible co-locations
>
> Bubble-flux: precise online qos management for increased utilization in ware-house scale computers

**ä¸Žå…¶ä»–å·¥ä½œçš„æ–°é¢–æ€§**ã€‚GMLake åœ¨ DNN è®­ç»ƒçš„ç‹¬ç‰¹å†…å­˜èŒƒå›´å†…å·¥ä½œï¼Œè¿™ä¸Ž vLLM å’Œ vMalloc/CUDA VMM ä¸åŒã€‚å®ƒä»¬éƒ½æ— æ³•è§£å†³ GMLake è§£å†³çš„é—®é¢˜ã€‚vLLM æ˜¯é’ˆå¯¹ Self-Attention æ“ä½œçš„åŸºäºŽç®—æ³•çš„è§£å†³æ–¹æ¡ˆï¼Œä½œç”¨äºŽå¼ é‡å†…éƒ¨ã€‚LLMs åŽŸæœ¬ç”¨å˜é•¿ä»¤ç‰Œå°†æ‰€æœ‰åºåˆ—å¡«å……è‡³æœ€å¤§é•¿åº¦ï¼Œå¯¼è‡´æ˜¾è‘—çš„å†—ä½™ã€‚vLLM ä½¿ç”¨æŸ¥æ‰¾è¡¨æ¥ç§»é™¤å¡«å……çš„ä»¤ç‰Œã€‚å› æ­¤ï¼ŒvLLM ç‰¹å®šäºŽè‡ªæ³¨æ„åŠ›ï¼Œè€Œ GMLake é’ˆå¯¹çš„æ˜¯æ›´å¹¿æ³›åœºæ™¯çš„ DNN è®­ç»ƒã€‚CUDA VMM ç±»ä¼¼äºŽ vMallocï¼Œæ˜¯ä¸€ä¸ªä½Žçº§ç³»ç»Ÿå·¥å…·ç”¨äºŽç¢Žç‰‡æ•´ç†ã€‚ç„¶è€Œï¼ŒCUDA VMM/vMalloc æ— æ³•æ„è¯†åˆ° DL æ¡†æž¶ä¸­å¸¸ç”¨çš„å†…å­˜æ± ã€‚æ²¡æœ‰å†…å­˜æ± è®¾è®¡ï¼Œæ€§èƒ½å°†æ˜¾è‘—ä¸‹é™ã€‚å› æ­¤ï¼Œè¿™äº›åŸºäºŽç³»ç»Ÿçš„å†…å­˜å·¥å…·ä¸èƒ½ç›´æŽ¥åœ¨ DL æ¡†æž¶ä¸Šå®žæ–½ã€‚

> Flashattention
>
> Flexgen
>
> Zero-offload
>
> 
